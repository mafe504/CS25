<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Stories - Workbench</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#020617', 
                            primary: '#0ea5e9', 
                            accent: '#f43f5e',
                            surface: '#0f172a',
                            glass: 'rgba(15, 23, 42, 0.95)',
                            harvard: '#A51C30',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'stitch': 'stitch 4s linear infinite',
                        'blink-fast': 'blink 0.5s infinite',
                        'dash-draw': 'dashDraw 10s linear infinite',
                        'pop-in': 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        stitch: {
                            '0%': { strokeDashoffset: '300' },
                            '100%': { strokeDashoffset: '0' }
                        },
                        dashDraw: {
                            'to': { strokeDashoffset: '-1000' }
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.9)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(14, 165, 233, 0.4)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Merriweather:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #020617; 
            color: white;
            overflow-x: hidden; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        @media (max-width: 768px) {
            .mobile-scroll-x {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
    <!-- Load React, ReactDOM, and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    
    const { useState, useEffect, useRef } = React;
    
    // --- Icons Helper ---
    const createIcon = (d, size, fill, stroke) => (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width={props.size || size} height={props.size || size} viewBox="0 0 24 24" fill={props.fill || fill} stroke={props.stroke || stroke} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d={d} />
      </svg>
    );
    
    // Core UI Icons
    const Play = createIcon("M5 3L19 12 5 21Z", 24, "none", "currentColor");
    const RefreshCcw = createIcon("M23 4v6h-6M1 20v-6h6M3.5 9a8 8 0 0 1 14.7-2.9L23 10M1 14a8 8 0 0 1 14.7 2.9L1 14", 24, "none", "currentColor");
    const ArrowRight = createIcon("M5 12h14M12 5l7 7-7 7", 24, "none", "currentColor");
    const Star = createIcon("M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 18.25l-6.18 3.84L7 14.14l-5-4.87 6.91-1.01L12 2Z", 24, "none", "currentColor");
    const Home = createIcon("M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z", 24, "none", "currentColor");
    const Trash2 = createIcon("M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6", 24, "none", "currentColor");
    const ChevronDown = createIcon("M6 9l6 6 6-6", 24, "none", "currentColor");
    const ChevronUp = createIcon("M18 15l-6-6-6 6", 24, "none", "currentColor");
    const BookOpen = createIcon("M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2Z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7Z", 24, "none", "currentColor");
    const Info = createIcon("M12 12h.01M11 12v3M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10Z", 24, "none", "currentColor");
    
    // Custom Clear Bulb Icon
    const ClearBulbIcon = (props) => (
         <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M9 18h6" />
            <path d="M10 22h4" />
            <path d="M12 2v1" />
            <path d="M12 2a5 5 0 0 1 5 5c0 2.5-3 5-3 5v3h-4v-3s-3-2.5-3-5a5 5 0 0 1 5-5Z" />
            <path d="M12 6v4" />
            <path d="M10 8h4" />
         </svg>
    );
    const Lightbulb = ClearBulbIcon; 

    // Manual Icons
    const PartsIcon = createIcon("M18 12h-5v5h5v-5Z M21 12h-1 M21 15h-1 M21 9V7a2 2 0 0 0-2-2h-2 M18 5V4 M15 5V4 M12 5v14 M9 5V4 M6 5V4 M5 5H3a2 2 0 0 0-2 2v2 M1 12h1 M1 15h1 M3 19h2a2 2 0 0 0 2-2v-2 M9 19v1 M12 19v1 M15 19v1 M19 19h2a2 2 0 0 0 2-2v-2", 24, "none", "currentColor"); // Chip
    const WrenchIcon = createIcon("M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z", 24, "none", "currentColor"); 
    
    const Lock = createIcon("M11 15v-1a3 3 0 0 0-6 0v1h2m3 0v-2c0-1.1.9-2 2-2s2 .9 2 2v2m-2-6h.01M21 7v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2Z", 24, "none", "currentColor");
    const Sparkles = createIcon("M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 18.25l-6.18 3.84L7 14.14l-5-4.87 6.91-1.01L12 2Z M20 4L18 6 16 4 18 2 20 4Z M4 20L6 18 8 20 6 22 4 20Z", 24, "none", "currentColor");
    const Users = createIcon("M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z M17 11a5 5 0 1 0 0-10 5 5 0 0 0 0 10Z M17 13a4 4 0 0 0 4 4v2", 24, "none", "currentColor");
    const FileText = createIcon("M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z M14 2v4a2 2 0 0 0 2 2h4M9 13h6M9 17h6M9 9h6", 24, "none", "currentColor");
    const Cpu = createIcon("M18 5a3 3 0 0 0-3-3H9a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3Z M12 8h.01M12 16h.01M12 12h.01M16 12h.01M8 12h.01M12 16h.01M16 8h.01M8 16h.01", 24, "none", "currentColor");
    const Scissors = createIcon("M22 4L10 16M2 22L14 10M17.5 7.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM6.5 15.5a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9Z", 24, "none", "currentColor");
    const RotateCw = createIcon("M23 4v6h-6M1 20v-6h6M3.5 9a8 8 0 0 1 14.7-2.9L23 10M1 14a8 8 0 0 0 14.7 2.9L1 14", 24, "none", "currentColor");
    const Shirt = createIcon("M10.5 4h3C14.78 4 16 5.12 16 6.5V9h-3V7h-3v2H8V6.5C8 5.12 9.22 4 10.5 4Z M16 9l-4 4-4-4V21h8V9Z", 24, "none", "currentColor");
    const Zap = createIcon("M13 2L3 14h9l-1 8 10-12h-9l1-8Z", 24, "none", "currentColor");
    const Aperture = createIcon("M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10Z M14.31 8a2 2 0 0 1-2.62 0", 24, "none", "currentColor");
    const Ghost = createIcon("M9 10L15 10 15 15 12 18 9 15Z M12 2C6.477 2 2 6.477 2 12S6.477 22 12 22s10-4.477 10-10S17.523 2 12 2Z M2 12l.5 2.5 1 1 1 2.5", 24, "none", "currentColor");
    const CheckCircle = createIcon("M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14l-3-3", 24, "none", "currentColor");
    const HelpCircle = createIcon("M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3 M12 17h.01", 24, "none", "currentColor");
    const Volume2 = createIcon("M11 5L6 9H2v6h4l5 4V5Z M15.54 8.46a4.99 4.99 0 0 1 0 7.08", 24, "none", "currentColor");
    const VolumeX = createIcon("M11 5L6 9H2v6h4l5 4V5Z M22 10l-4 4 M18 10l4 4", 24, "none", "currentColor");
    const ExternalLink = createIcon("M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3", 24, "none", "currentColor");

    // --- Constants & Data ---
    const GRID_ROWS = 6;
    const GRID_COLS = 10; 
    const CELL_SIZE = 20; 
    const GAP_SIZE = 25;  
    const STRIDE = CELL_SIZE + GAP_SIZE; // 45px pitch
    const SNAP_GLOBAL_OFFSET_X = 15.5; 

    // --- SVG Assets ---

    // 1. Felt Grid SVG Data URI
    const generateFeltGridSvg = (rows, cols, stride, size) => {
        const totalWidth = cols * stride + GAP_SIZE;
        const totalHeight = rows * stride + GAP_SIZE;
        const circles = '';

        const svgContent = `
            <svg width="${totalWidth}" height="${totalHeight}" viewBox="0 0 ${totalWidth} ${totalHeight}" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#64748b" rx="8"/> 
                <rect x="5" y="5" width="${totalWidth - 10}" height="${totalHeight - 10}" rx="6" fill="none" stroke="#475569" stroke-width="2"/>
            </svg>
        `.replace(/\s+/g, ' ').trim();

        return `url("data:image/svg+xml;base64,${btoa(svgContent)}")`;
    };

    const FELT_GRID_BG_URI = generateFeltGridSvg(GRID_ROWS, GRID_COLS, STRIDE, CELL_SIZE);

    // --- Circuit Background Animation ---
    const CircuitBackground = () => (
        <div className="absolute inset-0 overflow-hidden pointer-events-none">
            <svg className="w-full h-full opacity-20" preserveAspectRatio="xMidYMid slice">
                <defs>
                    <pattern id="circuit-pattern" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                         <path d="M20 20 H 80 V 80 H 20 Z" fill="none" stroke="#3b82f6" strokeWidth="0.5" opacity="0.3"/>
                         <circle cx="20" cy="20" r="2" fill="#3b82f6" opacity="0.5"/>
                         <circle cx="80" cy="80" r="2" fill="#3b82f6" opacity="0.5"/>
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#circuit-pattern)" />
                
                {/* Animated Lines */}
                <path d="M0 150 H 300 L 400 250 H 800 L 900 150 H 1500" stroke="#0ea5e9" strokeWidth="2" fill="none" strokeDasharray="20 20" className="animate-circuit-flow" />
                <path d="M-100 600 H 200 L 300 500 H 600 L 700 600 H 1200" stroke="#3b82f6" strokeWidth="2" fill="none" strokeDasharray="15 15" className="animate-circuit-flow" style={{animationDuration: '5s', opacity: 0.7}} />
                <path d="M1000 100 L 800 300 H 500 L 300 100" stroke="#60a5fa" strokeWidth="1.5" fill="none" strokeDasharray="10 10" className="animate-circuit-flow" style={{animationDuration: '7s', opacity: 0.5}} />
            </svg>
        </div>
    );

    // --- MODERN CUSTOM ICONS (SVG Components) ---
    const BatteryIcon = () => (
      <svg viewBox="0 0 45 45" className="w-full h-full filter drop-shadow-lg transition-all">
        <circle cx="0" cy="22.5" r="4" fill="#94a3b8" />
        <circle cx="45" cy="22.5" r="4" fill="#94a3b8" />
        <rect x="4" y="8" width="37" height="29" rx="4" fill="#22c55e" stroke="#15803d" strokeWidth="2" />
        <path d="M25 15 L20 28 L30 28 L25 35" fill="#fff" stroke="#fff" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" transform="translate(-2.5, -4)"/>
        <rect x="36" y="14" width="3" height="17" rx="1" fill="#15803d" opacity="0.3"/>
      </svg>
    );

    const WireIcon = () => (
      <svg viewBox="0 0 45 45" className="w-full h-full filter drop-shadow-md transition-all">
        <circle cx="0" cy="22.5" r="4" fill="#94a3b8" />
        <circle cx="45" cy="22.5" r="4" fill="#94a3b8" />
        <path d="M 4 22.5 H 41" stroke="#3b82f6" strokeWidth="6" strokeLinecap="round" />
        <path d="M 4 22.5 H 41" stroke="#60a5fa" strokeWidth="2" strokeLinecap="round" strokeDasharray="2 4" />
      </svg>
    );

    const ButtonIcon = () => (
      <svg viewBox="0 0 45 45" className="w-full h-full filter drop-shadow-lg transition-all">
        <circle cx="0" cy="22.5" r="4" fill="#94a3b8" />
        <circle cx="45" cy="22.5" r="4" fill="#94a3b8" />
        <rect x="4" y="12" width="37" height="21" rx="4" fill="#f87171" stroke="#b91c1c" strokeWidth="2" />
        <circle cx="22.5" cy="22.5" r="7" fill="#ef4444" stroke="#fee2e2" strokeWidth="2" />
      </svg>
    );

    const BuzzerIcon = () => (
      <svg viewBox="0 0 45 45" className="w-full h-full filter drop-shadow-lg transition-all">
        <circle cx="0" cy="22.5" r="4" fill="#94a3b8" />
        <circle cx="45" cy="22.5" r="4" fill="#94a3b8" />
        <rect x="4" y="8" width="37" height="29" rx="4" fill="#f97316" stroke="#c2410c" strokeWidth="2" />
        <g transform="translate(12, 12)" fill="none" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M7 5L3 8H1v6h2l4 3V5z" fill="white" stroke="none"/>
            <path d="M13 7c1.5 1.5 1.5 6.5 0 8" />
            <path d="M10 9c0.5 0.5 0.5 2.5 0 3" />
        </g>
      </svg>
    );

    const LightIcon = () => (
      <svg viewBox="0 0 45 45" className="w-full h-full filter drop-shadow-lg transition-all">
        <circle cx="0" cy="22.5" r="4" fill="#94a3b8" />
        <circle cx="45" cy="22.5" r="4" fill="#94a3b8" />
        <rect x="4" y="15" width="37" height="15" rx="7.5" fill="#fcd34d" stroke="#b45309" strokeWidth="2" />
        <circle cx="22.5" cy="22.5" r="5" fill="#fff" opacity="0.9"/>
        <path d="M 12 22.5 H 33" stroke="#b45309" strokeWidth="1" opacity="0.3" />
      </svg>
    );

    const COMPONENT_TYPES = {
      BATTERY: { 
        id: 'battery', label: 'Battery', 
        CustomIcon: BatteryIcon, 
        color: 'bg-green-500', logic: 'power', width: 'fixed',
        desc: "This is the power source for your whole project. It gives your circuit the energy it needs to light up or make sound."
      },
      CONNECTOR: { 
        id: 'connector', label: 'Wire', 
        CustomIcon: WireIcon, 
        color: 'bg-blue-400', logic: 'wire', width: 'flex',
        desc: "These pieces act like roads that electricity can travel on. They connect one part of your circuit to another."
      },
      BUTTON: { 
        id: 'button', label: 'Button', 
        CustomIcon: ButtonIcon, 
        color: 'bg-red-500', logic: 'switch', width: 'fixed',
        desc: "This is your on/off switch! When you press the button, it closes the circuit and lets electricity flow. When you let go, the circuit opens again and everything turns off."
      },
      SOUND: { 
        id: 'sound', label: 'Sound', 
        CustomIcon: BuzzerIcon, 
        color: 'bg-orange-500', logic: 'output', width: 'fixed',
        desc: "Output #1 - Sound. This piece makes noise when the circuit is complete. It might beep, buzz, or make a fun sound depending on your design."
      },
      LED: { 
        id: 'led', label: 'Light', 
        CustomIcon: LightIcon, 
        color: 'bg-yellow-400', logic: 'output', width: 'fixed',
        desc: "Output #2 - Light. This piece lights up when your circuit is correct. It's great for making glowing eyes, warning lights, or signals."
      },
    };
    
    const MISSIONS = [
      {
        id: 1,
        title: "The Deep-Sea Mission",
        theme: "ocean",
        image: "ðŸŒŠ",
        stages: [
          {
            description: "Your submarine's search beam is out! Bridge the gap to make the light shine.",
            challenge: "Connect a Battery and a Light in parallel.",
            hint: "Place Battery at top, Light below. Use same vertical columns.",
            requiredComponents: { battery: 1, led: 1 },
            solutionComponents: [
              { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
              { r1: 4, c1: 1, r2: 4, c2: 2, type: 'led' }
            ]
          }
        ]
      },
      {
        id: 2,
        title: "Robo-City Blackout",
        theme: "city", 
        image: "ðŸ™ï¸",
        stages: [
          {
            description: "Streetlights down! Power two streetlights at once.",
            challenge: "Use 2 lights on one power source.",
            hint: "Stack lights vertically on the same power columns.",
            requiredComponents: { battery: 1, led: 2 },
            solutionComponents: [
              { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
              { r1: 3, c1: 1, r2: 3, c2: 2, type: 'led' },
              { r1: 5, c1: 1, r2: 5, c2: 2, type: 'led' }
            ]
          }
        ]
      },
      {
        id: 3,
        title: "Midnight Circus",
        theme: "circus", 
        image: "ðŸŽª",
        stages: [
          {
            description: "Showtime! Build a circuit for a light and a buzzer.",
            challenge: "Use 1 light + 1 sound output.",
            hint: "Swap one light for a sound module.",
            requiredComponents: { battery: 1, sound: 1, led: 1 },
            solutionComponents: [
              { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
              { r1: 3, c1: 1, r2: 3, c1: 2, type: 'led' },
              { r1: 5, c1: 1, r2: 5, c2: 2, type: 'sound' }
            ]
          }
        ]
      },
      {
        id: 4,
        title: "Game Master",
        theme: "arcade",
        image: "ðŸŽ®",
        stages: [
          {
            description: "Pixel monsters! Connect sound with a long wire.",
            challenge: "1 sound + 1 button + 1 Long Wire.",
            hint: "Use the blue wire to bridge distant connections.",
            requiredComponents: { battery: 1, sound: 1, button: 1, connector: 1 },
            solutionComponents: [
              { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
              { r1: 3, c1: 2, r2: 3, c2: 3, type: 'button' },
              { r1: 5, c1: 3, r2: 5, c2: 4, type: 'sound' },
              { r1: 0, c1: 4, r2: 0, c2: 1, type: 'connector' } 
            ]
          }
        ]
      },
      {
        id: 5,
        title: "Haunted House",
        theme: "spooky",
        image: "ðŸ‘»",
        stages: [
          {
            description: "Fix the doorbell! Visitors can't ring it.",
            challenge: "Level 1: Battery + Button + Sound.",
            hint: "Power -> Button -> Sound. Close loop with wire if needed.",
            requiredComponents: { battery: 1, button: 1, sound: 1 },
            solutionComponents: [
              { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
              { r1: 3, c1: 2, r2: 3, c2: 3, type: 'button' },
              { r1: 5, c1: 3, r2: 5, c2: 4, type: 'sound' },
              { r1: 0, c1: 4, r2: 0, c2: 1, type: 'connector' } 
            ]
          },
          {
            description: "Fix the porch light too! It needs to work with the bell.",
            challenge: "Level 2: Add a Light to the sound circuit.",
            hint: "Add light parallel to the sound output.",
            requiredComponents: { battery: 1, button: 1, sound: 1, led: 1 },
            solutionComponents: [
              { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
              { r1: 3, c1: 2, r2: 3, c2: 3, type: 'button' },
              { r1: 5, c1: 3, r2: 5, c2: 4, type: 'sound' },
              { r1: 4, c1: 3, r2: 4, c2: 4, type: 'led' }, 
              { r1: 0, c1: 4, r2: 0, c2: 1, type: 'connector' }
            ]
          }
        ]
      },
      {
        id: 6,
        title: "Robo-Dance Party",
        theme: "lab", 
        image: "ðŸ¤–",
        stages: [
          {
            description: "Start the beat! Connect Battery to Sound.",
            challenge: "Level 1: Simple loop.",
            hint: "Battery + Sound on same columns.",
            requiredComponents: { battery: 1, sound: 1 },
            solutionComponents: [
              { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
              { r1: 4, c1: 1, r2: 4, c2: 2, type: 'sound' }
            ]
          }
        ]
      }
    ];

    // --- Audio Engine ---
    const playSound = (type) => {
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        const now = ctx.currentTime;

        switch (type) {
          case 'snap': 
            osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.05);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
          case 'pop':
            osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(600, now + 0.05);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
          case 'success': 
            osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, now); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); break;
          case 'error':
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.4); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(now); osc.stop(now + 0.4); break;
          case 'click':
            osc.type = 'square'; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
          case 'buzz': 
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(80, now); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); break;
          default: break;
        }
      } catch (e) { console.error("Audio error", e); }
    };

    // --- Helper Functions ---
    const renderRequiredComponents = (required, currentComponents) => {
        const currentCounts = currentComponents.reduce((acc, c) => {
            acc[c.type] = (acc[c.type] || 0) + 1;
            return acc;
        }, {});

        const componentsArray = Object.entries(required).map(([type, count]) => {
            const compDef = COMPONENT_TYPES[type.toUpperCase()];
            if (!compDef) return null;
            
            const current = currentCounts[type] || 0;
            const isMet = current >= count;
            
            return (
                <div key={type} className={`flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold border backdrop-blur-sm transition-all duration-300
                    ${isMet 
                        ? 'bg-green-500/20 border-green-500 text-green-300' 
                        : 'bg-slate-800/50 border-slate-600 text-slate-300'}`}>
                    <span className={isMet ? "text-green-400" : "text-blue-400"}>{count}x</span>
                    <span className="capitalize pr-2 flex items-center gap-2">{compDef.label} {isMet && <CheckCircle size={16} className="text-green-400" />}</span>
                </div>
            );
        });

        return (
            <div className="mt-4">
                <h4 className="font-bold text-xs text-blue-400 mb-2 uppercase tracking-widest">Required Parts</h4>
                <div className="flex flex-wrap gap-2">
                    {componentsArray}
                </div>
            </div>
        );
    };

    // --- Sparky Component ---
    const Sparky = ({ mood = 'happy', message, mobileCollapsed, onHint, isWorkbench, isVisible }) => {
      if (!isVisible) return null; 

      const isExcited = mood === 'excited';
      const isSpeaking = mood === 'speaking';

      // Mobile: fixed bottom left. Desktop: fixed bottom left above toolbar.
      const baseClasses = isWorkbench 
        ? "fixed left-4 bottom-24 md:bottom-36 z-50 pointer-events-none transition-all duration-300"
        : "fixed bottom-24 right-4 md:bottom-8 md:left-8 z-50 flex flex-col-reverse md:flex-row items-end pointer-events-none";

      const messageBoxClasses = isWorkbench
        ? "relative transition-all duration-300 mb-2"
        : "relative md:mr-4 ml-auto md:ml-0 transition-all duration-300";
      
      return (
        <div className={baseClasses}>
          <div className={`relative ${messageBoxClasses}`}>
            {onHint && (
                <button onClick={onHint} className="absolute -top-10 -right-2 pointer-events-auto bg-yellow-400 hover:bg-yellow-300 text-yellow-900 p-2 rounded-full shadow-lg shadow-yellow-500/50 animate-bounce transition-colors">
                    <ClearBulbIcon className="w-6 h-6" />
                </button>
            )}
            <div className="w-24 h-28 md:w-32 md:h-36 animate-float drop-shadow-[0_10px_20px_rgba(59,130,246,0.5)]">
                <svg viewBox="0 0 200 220" className="w-full h-full">
                <defs>
                    <linearGradient id="bodyGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stopColor="#3B82F6" />
                    <stop offset="100%" stopColor="#1D4ED8" />
                    </linearGradient>
                    <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur stdDeviation="4" result="blur" />
                    <feComposite in="SourceGraphic" in2="blur" operator="over" />
                    </filter>
                </defs>
                <line x1="100" y1="40" x2="100" y2="10" stroke="#94A3B8" strokeWidth="6" strokeLinecap="round" />
                <circle cx="100" cy="10" r="8" fill={isExcited ? "#EF4444" : "#F87171"} className={isExcited ? "animate-pulse" : ""} />
                <path d="M 35 120 Q 20 130 35 140" stroke="#3B82F6" strokeWidth="8" strokeLinecap="round" fill="none" />
                <path d="M 165 120 Q 180 130 165 140" stroke="#3B82F6" strokeWidth="8" strokeLinecap="round" fill="none" />
                <rect x="40" y="40" width="120" height="110" rx="24" fill="url(#bodyGradient)" stroke="#60A5FA" strokeWidth="2" />
                <rect x="55" y="60" width="90" height="65" rx="12" fill="#0F172A" stroke="#334155" strokeWidth="2" />
                <g className={isExcited ? "" : "sparky-eyes"}>
                    <ellipse cx="75" cy="90" rx="14" ry="18" fill="#06B6D4" filter="url(#glow)" />
                    <circle cx="79" cy="85" r="5" fill="white" opacity="0.9" />
                    <ellipse cx="125" cy="90" rx="14" ry="18" fill="#06B6D4" filter="url(#glow)" />
                    <circle cx="129" cy="85" r="5" fill="white" opacity="0.9" />
                </g>
                <g transform="translate(100, 135)">
                    {isSpeaking ? (
                        <rect x="-15" y="-4" width="30" height="8" rx="4" fill="#22C55E" className="sparky-mouth" />
                    ) : isExcited ? (
                        <path d="M -20 -5 Q 0 15 20 -5" stroke="#22C55E" strokeWidth="4" strokeLinecap="round" fill="none" />
                    ) : (
                        <rect x="-10" y="-2" width="20" height="4" rx="2" fill="#22C55E" />
                    )}
                </g>
                <path d="M 65 150 L 65 170 A 10 10 0 0 0 85 170 L 85 150 Z" fill="#1E40AF" />
                <path d="M 115 150 L 115 170 A 10 10 0 0 0 135 170 L 135 150 Z" fill="#1E40AF" />
                </svg>
            </div>
          </div>
          
          {message && (
            <div className={`glass-panel text-white p-4 rounded-2xl shadow-2xl w-64 border-l-4 border-blue-500 relative pointer-events-auto transform transition-all duration-300 animate-in fade-in slide-in-from-bottom-4 mx-4 md:mx-0`}>
               <div className="flex items-center gap-2 mb-2 border-b border-slate-600 pb-2">
                 <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                 <p className="font-bold text-[10px] text-blue-300 uppercase tracking-widest">SPARKY SAYS:</p>
               </div>
               <p className="text-sm leading-relaxed text-slate-100 font-light">{message}</p>
            </div>
          )}
        </div>
      );
    };

    // --- Modals (Glassmorphism Update) ---

    const Modal = ({ title, children, onClose }) => (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-md p-4 animate-in fade-in duration-200">
            <div className="glass-panel bg-slate-800/90 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300 animate-in zoom-in-95 ring-1 ring-white/10 border-t border-white/10">
                <div className="sticky top-0 bg-slate-800/95 border-b border-slate-700 p-4 flex justify-between items-center backdrop-blur-xl z-10">
                    <h3 className="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">{title}</h3>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div className="p-6 text-slate-300">
                    {children}
                </div>
            </div>
        </div>
    );

    const CreditsModal = ({ onClose }) => {
        return (
            <Modal title="Credits" onClose={onClose}>
                <div className="text-center p-4 relative overflow-hidden">
                    <div className="absolute inset-0 bg-gradient-to-tr from-blue-500/10 to-purple-500/10 animate-pulse"></div>
                    <div className="relative z-10 animate-pop-in">
                        <h4 className="text-3xl font-black text-white mb-2 drop-shadow-lg">Circuit Stories</h4>
                        <p className="text-sm text-blue-300 mb-8 font-medium">Digital Fabrication in Education</p>
                        
                        <h5 className="font-bold text-xs text-slate-500 mb-4 uppercase tracking-[0.2em]">The Team</h5>
                        <div className="grid grid-cols-3 gap-4 mb-8">
                            <div className="group p-4 rounded-2xl bg-slate-700/40 border border-slate-600/50 flex flex-col items-center hover:border-blue-500/50 hover:bg-slate-700/80 transition-all duration-300 hover:-translate-y-1">
                                <div className="w-14 h-14 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold mb-3 shadow-lg shadow-blue-500/20 group-hover:shadow-blue-500/40 transition-shadow">DK</div>
                                <p className="font-bold text-sm text-white">David Kim</p>
                            </div>
                            <div className="group p-4 rounded-2xl bg-slate-700/40 border border-slate-600/50 flex flex-col items-center hover:border-green-500/50 hover:bg-slate-700/80 transition-all duration-300 hover:-translate-y-1">
                                <div className="w-14 h-14 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-bold mb-3 shadow-lg shadow-green-500/20 group-hover:shadow-green-500/40 transition-shadow">MAH</div>
                                <p className="font-bold text-sm text-white text-center leading-tight">Musa Abu Hadeed</p>
                            </div>
                            <div className="group p-4 rounded-2xl bg-slate-700/40 border border-slate-600/50 flex flex-col items-center hover:border-yellow-500/50 hover:bg-slate-700/80 transition-all duration-300 hover:-translate-y-1">
                                <div className="w-14 h-14 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center text-white font-bold mb-3 shadow-lg shadow-yellow-500/20 group-hover:shadow-yellow-500/40 transition-shadow">JLH</div>
                                <p className="font-bold text-sm text-white text-center leading-tight">Julie J Heck</p>
                            </div>
                        </div>
                        <p className="font-serif text-2xl text-[#A51C30] font-bold tracking-wide drop-shadow-md mt-6 border-t border-slate-600/30 pt-6">Harvard Graduate School of Education</p>
                        <div className="mt-6">
                             <a href="https://mafe504.github.io/CS25/oldversion.html" target="_blank" className="text-xs text-blue-400 hover:text-blue-300 hover:underline flex items-center justify-center gap-1 transition-colors">
                                View Version 1 <ExternalLink size={12} />
                             </a>
                        </div>
                    </div>
                </div>
            </Modal>
        );
    };

    const ProjectBriefModal = ({ onClose }) => (
        <Modal title="About Circuit Stories" onClose={onClose}>
            <div className="space-y-6">
                <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/30 animate-pop-in">
                    <h4 className="text-lg font-bold text-white mb-2 flex items-center gap-2"><Sparkles size={18} className="text-yellow-400"/> Motivation</h4>
                    <p className="text-sm leading-relaxed text-slate-300">
                        The question our group aimed to solve was: "How can we help students learn circuits in a way that is concrete, memorable, and motivating?" Our prototype for the final project is a story-based circuit kit called Circuit Stories.
                    </p>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="p-4 rounded-xl bg-slate-800/50 border border-slate-700 animate-pop-in" style={{animationDelay: '0.1s'}}>
                        <h4 className="font-bold text-white mb-2 text-sm uppercase tracking-wider">Learning Goals</h4>
                        <ul className="space-y-2 text-sm text-slate-300">
                            <li className="flex items-start gap-2"><span className="text-green-400">âœ“</span> Identify the four key circuit components: battery, input (button), output (light/sound), and conductor (connector).</li>
                            <li className="flex items-start gap-2"><span className="text-green-400">âœ“</span> Explain the difference between open and closed circuits.</li>
                            <li className="flex items-start gap-2"><span className="text-green-400">âœ“</span> Explain and build a simple circuit using one battery and one output.</li>
                            <li className="flex items-start gap-2"><span className="text-green-400">âœ“</span> Explain and build complex circuits by using additional connectors, buttons, or outputs.</li>
                        </ul>
                    </div>
                    <div className="p-4 rounded-xl bg-slate-800/50 border border-slate-700 animate-pop-in" style={{animationDelay: '0.2s'}}>
                         <h4 className="font-bold text-white mb-2 text-sm uppercase tracking-wider">Philosophy</h4>
                         <p className="text-sm text-slate-300 leading-relaxed mb-2">
                             Grounded in both <strong>constructionism</strong> and <strong>constructivism</strong>.
                         </p>
                         <p className="text-sm text-slate-300 leading-relaxed">
                             Constructivism emphasizes connecting new ideas to prior knowledge (like cause and effect). Constructionism states that learners understand best when creating meaningful artifacts. Circuit Stories blends these by placing students inside narrative scenarios where they build physical circuits to "solve" story challenges.
                         </p>
                    </div>
                </div>
                <div className="text-center pt-4 border-t border-white/10">
                     <a href="https://mafe504.github.io/CS25/oldversion.html" target="_blank" className="text-xs text-blue-400 hover:text-blue-300 hover:underline flex items-center justify-center gap-1 transition-colors">
                        View Version 1 <ExternalLink size={12} />
                     </a>
                </div>
            </div>
        </Modal>
    );

    const SewingSimulator = ({ onClose }) => {
        const [progress, setProgress] = useState(0);

        useEffect(() => {
            const interval = setInterval(() => {
                setProgress(prev => (prev + 1) % 100);
            }, 50);
            return () => clearInterval(interval);
        }, []);

        const width = 260;
        const height = 180;
        const perimeter = 2 * (width + height);
        const currentDist = (progress / 100) * perimeter;
        
        let nx = 0, ny = 0;
        if (currentDist < width) { nx = currentDist; ny = 0; }
        else if (currentDist < width + height) { nx = width; ny = currentDist - width; }
        else if (currentDist < 2 * width + height) { nx = width - (currentDist - (width + height)); ny = height; }
        else { nx = 0; ny = height - (currentDist - (2 * width + height)); }

        return (
            <Modal title="Wearable Mode: Sewing Tutorial" onClose={onClose}>
                 <div className="flex flex-col items-center">
                    <div className="w-full max-w-md bg-slate-900 p-6 rounded-2xl border border-slate-700 shadow-inner mb-6 relative overflow-hidden">
                         <div className="absolute top-2 right-2 px-2 py-1 bg-teal-900/50 border border-teal-500/30 rounded text-[10px] text-teal-300 font-bold uppercase">Simulation Active</div>
                         
                         {/* Simulated Felt Board from uploaded image */}
                         <svg viewBox="-20 -20 300 220" className="w-full h-48 drop-shadow-2xl">
                            <rect x="-20" y="-20" width="300" height="220" fill="#1e293b" />
                            <rect x="10" y="10" width="260" height="180" rx="15" fill="#334155" stroke="#475569" strokeWidth="2"/>
                            
                            {/* Inner Grid Holes */}
                            {Array.from({ length: 4 }).map((_, r) => (
                                Array.from({ length: 8 }).map((_, c) => (
                                    <circle key={`grid-${r}-${c}`} cx={40 + c * 30} cy={40 + r * 40} r="2" fill="#1e293b" stroke="#64748b" strokeWidth="1" opacity="0.5"/>
                                ))
                            ))}

                            {/* Perimeter Sewing Holes */}
                            {Array.from({ length: 26 }).map((_, i) => {
                                const step = (width * 2 + height * 2) / 26;
                                let dist = i * step;
                                let hx=0, hy=0;
                                if (dist < width) { hx = dist; hy = 0; }
                                else if (dist < width+height) { hx = width; hy = dist-width; }
                                else if (dist < 2*width+height) { hx = width-(dist-(width+height)); hy = height; }
                                else { hx = 0; hy = height-(dist-(2*width+height)); }
                                return <circle key={i} cx={10+hx} cy={10+hy} r="2" fill="#1e293b" stroke="#cbd5e1" strokeWidth="1"/>;
                            })}

                            <path d={`M 10 10 L ${10+nx} ${10+ny}`} stroke="#38bdf8" strokeWidth="2" fill="none" strokeDasharray="4 2" className="drop-shadow-md"/>

                            <g transform={`translate(${10+nx}, ${10+ny}) rotate(-45)`}>
                                <rect x="-1" y="-15" width="2" height="30" fill="#e2e8f0" />
                                <circle cx="0" cy="-12" r="1.5" fill="white" />
                            </g>
                         </svg>
                    </div>

                    <div className="text-left w-full space-y-4">
                        <div className="flex items-start gap-4">
                            <div className="w-10 h-10 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center font-bold shrink-0">1</div>
                            <div>
                                <h5 className="text-white font-bold mb-1">Secure the Board</h5>
                                <p className="text-sm text-slate-400">Place the felt breadboard on your shirt. Use pins to hold it steady.</p>
                            </div>
                        </div>
                        <div className="flex items-start gap-4">
                            <div className="w-10 h-10 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center font-bold shrink-0">2</div>
                            <div>
                                <h5 className="text-white font-bold mb-1">Stitch the Perimeter</h5>
                                <p className="text-sm text-slate-400">Using non-conductive thread, sew through the outer holes (shown in animation) to attach the board firmly to the fabric.</p>
                            </div>
                        </div>
                    </div>

                    <button onClick={onClose} className="mt-8 w-full py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-xl shadow-lg shadow-teal-900/20 transition-all">Got it!</button>
                 </div>
            </Modal>
        );
    };

    // --- Main App ---

    function App() {
      const [screen, setScreen] = useState('landing');
      const [activeMissionId, setActiveMissionId] = useState(null);
      const [activeStageIndex, setActiveStageIndex] = useState(0); 
      const [components, setComponents] = useState([]);
      const [selectedTool, setSelectedTool] = useState(null);
      const [dragStart, setDragStart] = useState(null); 
      const [showMissionDetails, setShowMissionDetails] = useState(false);
      const [audioEnabled, setAudioEnabled] = useState(true);
      const [isRunning, setIsRunning] = useState(false);
      const [isButtonPressed, setIsButtonPressed] = useState(false);
      const [success, setSuccess] = useState(false);
      const [sparkyMsg, setSparkyMsg] = useState("Hi! I'm Sparky. Let's build circuits!");
      const [manualTab, setManualTab] = useState('parts'); 
      const [isSolutionMode, setIsSolutionMode] = useState(false); 
      const [showCredits, setShowCredits] = useState(false); 
      const [showBrief, setShowBrief] = useState(false); 
      const [showSewing, setShowSewing] = useState(false); 
      const [isSparkyVisible, setIsSparkyVisible] = useState(false); 
      
      // Removed separate success modal state to keep UI fluid

      const triggerSound = (type) => { if (audioEnabled) playSound(type); };

      const handleStartMission = (id) => {
        if (id === 'coming-soon') return; 
        setActiveMissionId(id);
        setActiveStageIndex(0); 
        setScreen('workbench');
        setComponents([]);
        setSuccess(false);
        setIsRunning(false);
        setIsSolutionMode(false); 
        setShowMissionDetails(false);
        setIsSparkyVisible(true);
        const mission = MISSIONS.find(m => m.id === id);
        setSparkyMsg(mission.stages[0].description);
        triggerSound('snap');
      };

      const handleNextStage = () => {
        const mission = MISSIONS.find(m => m.id === activeMissionId);
        if (activeStageIndex < mission.stages.length - 1) {
            setActiveStageIndex(prev => prev + 1);
            setSuccess(false);
            setIsRunning(false);
            setIsSolutionMode(false); 
            setComponents(components.filter(c => ['battery','led','sound','button'].indexOf(c.type) === -1)); 
            const nextStage = mission.stages[activeStageIndex + 1];
            setSparkyMsg(nextStage.description);
            triggerSound('snap');
        } else {
             setScreen('mission-select');
        }
      };

      const handleHint = () => {
        const mission = MISSIONS.find(m => m.id === activeMissionId);
        if (!mission) return;
        const hint = mission.stages[activeStageIndex].hint;
        setSparkyMsg(hint ? `HINT: ${hint}` : "No hint available!");
        triggerSound('click');
      };

      const handleSnapClick = (r, c) => {
        if (isRunning) return;
        if (!selectedTool) {
          setSparkyMsg("Select a component from the kit below!");
          return;
        }
        
        const toolInfo = COMPONENT_TYPES[selectedTool.toUpperCase()];

        const isOccupied = components.some(comp => 
             (comp.r1 === r && comp.c1 === c) || (comp.r2 === r && comp.c2 === c)
        );

        if (isOccupied) {
             setSparkyMsg("This snap is already occupied! Choose an empty one.");
             triggerSound('error');
             return;
        }

        if (!dragStart) {
          setDragStart({ r, c });
          if (toolInfo.width === 'flex') {
              setSparkyMsg("Click another snap to connect the wire.");
          } else {
              setSparkyMsg("Place the component on an adjacent snap.");
          }
          triggerSound('snap');
        } else {
          let r1 = dragStart.r, c1 = dragStart.c, r2 = r, c2 = c;

          if (toolInfo.width === 'fixed') {
              if (r1 !== r2) {
                  setSparkyMsg("Fixed components must be horizontal!");
                  triggerSound('error');
                  setDragStart(null);
                  return;
              }
              if (Math.abs(c1 - c2) !== 1) {
                  setSparkyMsg("Fixed components must span exactly 2 adjacent snaps.");
                  triggerSound('error');
                  setDragStart(null);
                  return;
              }
          } else {
              if (r1 === r2 && c1 === c2) {
                  setSparkyMsg("Connect to a different snap!");
                  triggerSound('error');
                  return;
              }
          }
          
          let finalC1 = c1, finalC2 = c2;
          if (toolInfo.width === 'fixed') {
             finalC1 = Math.min(c1, c2);
             finalC2 = Math.max(c1, c2);
          }

          const newComp = { 
              id: Date.now(), 
              type: selectedTool, 
              r1: r1, 
              c1: finalC1, 
              r2: r2, 
              c2: finalC2, 
              active: false 
          };
          const newComponents = [...components, newComp];
          setComponents(newComponents);
          setSparkyMsg("Component placed.");
          triggerSound('snap');
          if (isButtonPressed) updateSimulationState(true, newComponents);
          setDragStart(null);
        }
      };

      const handleRemoveComponent = (id) => {
        if (isRunning) return;
        const newComponents = components.filter(c => c.id !== id);
        setComponents(newComponents);
        triggerSound('pop');
        if (isButtonPressed) updateSimulationState(true, newComponents);
      };

      const loadSolution = () => {
        const mission = MISSIONS.find(m => m.id === activeMissionId);
        if (!mission) return;
        const stage = mission.stages[activeStageIndex];
        const solvedComps = stage.solutionComponents.map((sc, idx) => ({ id: `sol-${idx}`, ...sc, active: false }));
        setComponents(solvedComps);
        setSparkyMsg("Here is the solution layout.");
        triggerSound('snap');
        setIsSolutionMode(true); 
        setIsRunning(false);
        setSuccess(false);
      };

      const handleTryItYourself = () => {
        setComponents([]); 
        setIsRunning(false);
        setSuccess(false);
        setSparkyMsg("Board cleared. Try building it now!");
        triggerSound('pop');
        setIsSolutionMode(false); 
        setIsButtonPressed(false);
      };

      const clearBoard = () => {
        setComponents([]);
        setIsRunning(false);
        setSuccess(false);
        setSparkyMsg("Board cleared.");
        triggerSound('pop');
        setIsSolutionMode(false); 
        setIsButtonPressed(false);
      };

      const runSimulation = (isCurrentlyPressed, currentComponents) => {
        const currentMission = MISSIONS.find(m => m.id === activeMissionId);
        if (!currentMission) return { activeComponentIds: new Set(), missionSuccess: false };
        const stage = currentMission.stages[activeStageIndex];

        const adj = {}; 
        for(let i=0; i<GRID_COLS; i++) adj[i] = [];

        let batteries = currentComponents.filter(c => c.type === 'battery');
        // FIX 1: Check if active components > 0 for basic open circuit detection
        if (batteries.length === 0) return { activeComponentIds: new Set(), missionSuccess: false, isOpen: true };

        currentComponents.forEach(comp => {
          const isActiveSwitch = comp.type !== 'button' || isCurrentlyPressed; 
          if (isActiveSwitch) {
              adj[comp.c1].push({ target: comp.c2, id: comp.id, type: comp.type });
              adj[comp.c2].push({ target: comp.c1, id: comp.id, type: comp.type });
          }
        });

        let activeComponentIds = new Set();
        let battery = batteries[0];
        const sourceCol = battery.c2;
        const sinkCol = battery.c1; 

        const findPaths = (currCol, visitedCols, currentPathCompIds) => {
          if (currCol === sinkCol) {
            currentPathCompIds.forEach(id => activeComponentIds.add(id));
            return;
          }
          visitedCols.add(currCol);
          const neighbors = adj[currCol] || [];
          for (let edge of neighbors) {
              if (edge.id === battery.id && edge.target === sinkCol) continue;
              if (!visitedCols.has(edge.target)) {
                findPaths(edge.target, new Set(visitedCols), [...currentPathCompIds, edge.id]);
              }
          }
        };
        
        findPaths(sourceCol, new Set([sourceCol]), [battery.id]);
        
        // FIX 2: Properly detect if circuit is truly complete (active > 0)
        let circuitCompleted = activeComponentIds.size > 0; 
        let missionSuccess = circuitCompleted;

        if (missionSuccess) {
          const currentComponentCounts = currentComponents.reduce((acc, c) => {
              acc[c.type] = (acc[c.type] || 0) + 1;
              return acc;
          }, {});
          
          Object.keys(stage.requiredComponents).forEach(reqType => {
              if ((currentComponentCounts[reqType] || 0) < stage.requiredComponents[reqType]) missionSuccess = false;
          });
          
          if (missionSuccess) {
              const activeComponentTypes = currentComponents.filter(c => activeComponentIds.has(c.id)).map(c => c.type);
              const activeLedCount = activeComponentTypes.filter(t => t === 'led').length;
              const activeSoundCount = activeComponentTypes.filter(t => t === 'sound').length;

              if (stage.requiredComponents.led && activeLedCount < stage.requiredComponents.led) missionSuccess = false;
              if (stage.requiredComponents.sound && activeSoundCount < stage.requiredComponents.sound) missionSuccess = false;
          }
        }
        
        // Return isOpen status based on whether we found a path
        return { activeComponentIds, missionSuccess, isOpen: !circuitCompleted };
      };

      const updateSimulationState = (pressedState, comps) => {
          const { activeComponentIds, missionSuccess, isOpen } = runSimulation(pressedState, comps);
          setIsRunning(pressedState);
          setSuccess(missionSuccess);
          setComponents(comps.map(c => ({ ...c, active: activeComponentIds.has(c.id) })));

          if (pressedState) {
              if (missionSuccess) {
                  setSparkyMsg("MISSION ACCOMPLISHED! Circuit Operational. Well done!");
                  triggerSound('success');
                  // Removed Modal - Feedback is visual on components now
                  if (comps.filter(c => c.type === 'sound' && activeComponentIds.has(c.id)).length > 0) triggerSound('buzz');
              } else if (isOpen) {
                  setSparkyMsg("Circuit is open! Check your connections.");
                  triggerSound('error');
              } else {
                  // Circuit is closed (electricity flowing) but mission requirements not met
                  setSparkyMsg("Circuit works, but you need different parts for this mission.");
                  triggerSound('click');
              }
          } else {
              setSparkyMsg("Circuit open. Standing by.");
          }
      };

      const handleAutoSimulation = () => {
        const currentMission = MISSIONS.find(m => m.id === activeMissionId);
        if (!currentMission || currentMission.stages[activeStageIndex].requiredComponents.button) return;
        
        if (!isRunning) {
            updateSimulationState(true, components);
            setTimeout(() => {
                setIsRunning(false);
                setComponents(prev => prev.map(c => ({ ...c, active: false })));
            }, 3000);
        }
      };

      const toggleButtonPress = () => {
        const nextIsPressed = !isButtonPressed; 
        setIsButtonPressed(nextIsPressed);
        triggerSound('click');
        updateSimulationState(nextIsPressed, components);
      };

      const currentMission = MISSIONS.find(m => m.id === activeMissionId);
      const currentStage = currentMission ? currentMission.stages[activeStageIndex] : null;

      // --- RENDER ---
      return (
        <div className="min-h-screen flex flex-col overflow-hidden text-slate-200 selection:bg-blue-500 selection:text-white">
          
          {/* Modals */}
          {showCredits && <CreditsModal onClose={() => setShowCredits(false)} />}
          {showBrief && <ProjectBriefModal onClose={() => setShowBrief(false)} />}
          {showSewing && <SewingSimulator onClose={() => setShowSewing(false)} />} 

          {/* --- LANDING SCREEN --- */}
          {screen === 'landing' && (
            <div className="flex-1 flex flex-col items-center justify-center p-6 relative overflow-hidden tech-bg">
                {/* Animated Background Elements */}
                <div className="absolute inset-0 pointer-events-none overflow-hidden">
                    <div className="absolute top-1/4 left-1/4 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl animate-pulse-slow"></div>
                    <div className="absolute bottom-1/3 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl animate-pulse-slow" style={{animationDelay: '1s'}}></div>
                     {/* Electric Lines */}
                     <svg className="absolute inset-0 w-full h-full opacity-30">
                         <path d="M0 100 Q 200 200 400 100 T 800 100" fill="none" stroke="#38BDF8" strokeWidth="2" strokeDasharray="10 10" className="animate-current-flow" />
                         <path d="M-100 500 Q 300 300 600 600 T 1200 400" fill="none" stroke="#818CF8" strokeWidth="2" strokeDasharray="15 15" className="animate-current-flow" style={{animationDuration: '15s'}}/>
                     </svg>
                </div>

                <div className="z-10 text-center max-w-4xl w-full">
                    <div className="mb-8 inline-block relative">
                        <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg blur opacity-75 animate-pulse"></div>
                        <h1 className="relative text-6xl md:text-8xl font-black tracking-tighter text-white drop-shadow-2xl uppercase">
                            Circuit<br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">Stories</span>
                        </h1>
                    </div>

                    <p className="text-lg md:text-xl mb-12 text-slate-400 font-light max-w-lg mx-auto leading-relaxed">
                        Master the art of electronics through interactive storytelling and simulation.
                    </p>
                    
                    <div className="flex flex-col sm:flex-row justify-center gap-4 mb-16">
                        <button onClick={() => { setScreen('mission-select'); triggerSound('snap'); }} className="group relative px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white text-lg font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all hover:scale-105 active:scale-95 flex items-center justify-center gap-3 overflow-hidden">
                            <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                            <Play fill="currentColor" /> 
                            <span className="relative">INITIATE MISSION</span>
                        </button>
                        <button onClick={() => { setScreen('manual'); triggerSound('click'); }} className="px-8 py-4 bg-slate-800 hover:bg-slate-700 text-slate-200 text-lg font-bold rounded-xl border border-slate-700 transition-all hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                            <BookOpen size={20} /> Field Manual
                        </button>
                    </div>
                    
                    <div className="flex justify-center gap-6 text-sm font-semibold text-slate-500">
                         <button onClick={() => setShowCredits(true)} className="hover:text-blue-400 transition-colors">CREDITS</button>
                         <button onClick={() => setShowBrief(true)} className="hover:text-blue-400 transition-colors">ABOUT</button>
                    </div>
                </div>
                <Sparky mood="happy" message="Systems Online. Ready for input." mobileCollapsed={false} isVisible={true} />
            </div>
          )}

          {/* ... (Other screens: Mission Select, Manual, Workbench remain largely same, just importing new icons and modal logic) ... */}
          {screen === 'mission-select' && (
              <div className="flex-1 flex flex-col overflow-hidden bg-slate-900">
                 <header className="glass-panel border-b-0 border-x-0 rounded-none sticky top-0 z-20 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                    <h2 className="text-2xl font-black tracking-tight text-white flex items-center gap-3">
                      <div className="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20"><Zap size={24} fill="currentColor"/></div> 
                      Mission Control
                    </h2>
                    <div className="flex gap-3">
                        <button onClick={() => setScreen('manual')} className="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-200 text-sm font-bold transition-colors flex items-center gap-2"><BookOpen size={16}/> Manual</button>
                        <button onClick={() => setScreen('landing')} className="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-200 text-sm font-bold transition-colors flex items-center gap-2"><Home size={16}/> Exit</button>
                    </div>
                  </header>

                  <div className="flex-1 overflow-y-auto p-6">
                      <div className="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                          {MISSIONS.map((mission) => (
                              <div key={mission.id} onClick={() => handleStartMission(mission.id)} className="group relative bg-slate-800 hover:bg-slate-750 border border-slate-700 hover:border-blue-500/50 rounded-2xl overflow-hidden transition-all duration-300 hover:-translate-y-1 cursor-pointer shadow-lg hover:shadow-blue-900/20">
                                    <div className="h-32 bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center relative overflow-hidden">
                                        <div className="text-6xl transition-transform duration-500 group-hover:scale-110 group-hover:rotate-3">{mission.image}</div>
                                        <div className="absolute inset-0 bg-blue-500/0 group-hover:bg-blue-500/5 transition-colors"></div>
                                    </div>
                                    <div className="p-5">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-bold text-lg text-white group-hover:text-blue-400 transition-colors">{mission.title}</h3>
                                            <span className="text-[10px] font-black bg-slate-700 text-slate-300 px-2 py-1 rounded uppercase tracking-wider">LVL {mission.id}</span>
                                        </div>
                                        <p className="text-sm text-slate-400 leading-snug">{mission.stages[0].description}</p>
                                    </div>
                              </div>
                          ))}
                          
                           {/* Coming Soon Tiles */}
                           <div className="relative bg-slate-800/40 border border-slate-700/50 rounded-2xl p-6 flex flex-col items-center justify-center text-center opacity-75 grayscale hover:grayscale-0 transition-all">
                                <Cpu size={48} className="mb-3 text-indigo-400" />
                                <h3 className="font-bold text-slate-300">Arduino Connect</h3>
                                <span className="text-xs text-slate-500 mt-2 uppercase tracking-widest font-bold">Coming Soon</span>
                           </div>
                           <div onClick={() => setShowSewing(true)} className="cursor-pointer relative bg-slate-800 border border-slate-700 hover:border-teal-500/50 rounded-2xl p-6 flex flex-col items-center justify-center text-center transition-all hover:-translate-y-1 hover:shadow-lg">
                                <Shirt size={48} className="mb-3 text-teal-400" />
                                <h3 className="font-bold text-white">Wearable Mode</h3>
                                <span className="text-xs text-teal-400 mt-2 uppercase tracking-widest font-bold">Tutorial Available</span>
                           </div>
                           <div className="relative bg-slate-800/40 border border-slate-700/50 rounded-2xl p-6 flex flex-col items-center justify-center text-center opacity-75 grayscale hover:grayscale-0 transition-all">
                                <BookOpen size={48} className="mb-3 text-pink-400" />
                                <h3 className="font-bold text-slate-300">Story Magazine</h3>
                                <span className="text-xs text-slate-500 mt-2 uppercase tracking-widest font-bold">Coming Soon</span>
                           </div>
                      </div>
                  </div>
              </div>
          )}

          {/* --- MANUAL SCREEN --- */}
          {screen === 'manual' && (
            <div className="flex-1 flex flex-col bg-slate-900">
              <header className="glass-panel border-b-0 border-x-0 rounded-none sticky top-0 z-20 px-6 py-4 flex items-center justify-between">
                    <h2 className="text-xl md:text-2xl font-black text-white flex items-center gap-3"><BookOpen className="text-blue-500" /> Field Manual</h2>
                    <button onClick={() => setScreen('landing')} className="text-slate-400 hover:text-white transition-colors flex items-center gap-2 font-bold text-sm"><ArrowRight className="rotate-180" size={16}/> Back</button>
               </header>
               
               <div className="flex-1 flex flex-col md:flex-row overflow-hidden max-w-7xl mx-auto w-full p-4 md:p-8 gap-6">
                   <div className="w-full md:w-64 flex flex-row md:flex-col gap-2 shrink-0 overflow-x-auto md:overflow-visible pb-2">
                        <button onClick={() => setManualTab('parts')} className={`p-4 rounded-xl font-bold text-left flex items-center gap-3 transition-all ${manualTab === 'parts' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><PartsIcon size={18}/> Parts Data</button>
                        <button onClick={() => setManualTab('build')} className={`p-4 rounded-xl font-bold text-left flex items-center gap-3 transition-all ${manualTab === 'build' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><AssemblyIcon size={18}/> Assembly</button>
                   </div>
                   
                   <div className="flex-1 overflow-y-auto rounded-2xl bg-slate-800 border border-slate-700 p-6 md:p-8 shadow-2xl">
                       {manualTab === 'parts' && (
                           <div className="space-y-4">
                               <h3 className="text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-4">Component Database</h3>
                               {Object.values(COMPONENT_TYPES).map(comp => (
                                   <div key={comp.id} className="flex items-start gap-4 p-4 rounded-xl bg-slate-900/50 border border-slate-700/50">
                                       <div className="w-16 h-16 bg-slate-800 rounded-lg flex items-center justify-center shrink-0">
                                          <div className="w-10 h-10 scale-125"><comp.CustomIcon /></div>
                                       </div>
                                       <div>
                                           <h4 className="font-bold text-blue-400 text-lg mb-1">{comp.label}</h4>
                                           <p className="text-sm text-slate-400 leading-relaxed">{comp.desc}</p>
                                       </div>
                                   </div>
                               ))}
                           </div>
                       )}
                       {manualTab === 'build' && (
                           <div className="space-y-8 text-slate-300">
                               <div>
                                   <h3 className="text-2xl font-bold text-white mb-4">Building Tips & Rules</h3>
                                   
                                   <div className="space-y-6">
                                        <div className="p-4 bg-slate-700/30 rounded-xl border border-slate-600">
                                            <h4 className="font-bold text-white mb-2 text-blue-400 flex items-center gap-2"><Zap size={18} className="text-yellow-400"/> The Golden Rule</h4>
                                            <p className="text-sm">A circuit must form a complete, unbroken loop from the <strong>Battery (+)</strong> back to the <strong>Battery (-)</strong>. If the loop is broken (an <strong>open circuit</strong>), nothing works.</p>
                                        </div>

                                        <div className="p-4 bg-slate-700/30 rounded-xl border border-slate-600">
                                            <h4 className="font-bold text-white mb-2 text-blue-400">How the Felt Board Works (The Grid)</h4>
                                            <p className="text-sm">The felt board is a simplified breadboard. All snaps in a single <strong>vertical column</strong> are permanently connected by conductive thread, simulating a strip. Components must bridge columns to connect them.</p>
                                        </div>

                                        <div className="p-4 bg-slate-700/30 rounded-xl border border-slate-600">
                                            <h4 className="font-bold text-white mb-2 text-blue-400">Component Sizing</h4>
                                            <ul className="list-disc pl-5 space-y-1 text-sm">
                                                <li><strong>Fixed Parts (Battery, Light, Button, Sound):</strong> These pieces are rigid and can only span <strong>two adjacent snaps</strong> in the <strong>same row</strong> (size 1).</li>
                                                <li><strong>Flexible Wire (Connector):</strong> This piece is versatile and can connect <strong>any two snaps</strong> on the board, bridging large gaps or connecting diagonally.</li>
                                            </ul>
                                        </div>

                                        <div className="p-4 bg-slate-700/30 rounded-xl border border-slate-600">
                                            <h4 className="font-bold text-white mb-2 text-blue-400">Types of Circuits</h4>
                                            <ul className="list-disc pl-5 space-y-1 text-sm">
                                                <li><strong>Simple Loop:</strong> One battery powers one output (Light/Sound).</li>
                                                <li><strong>Parallel:</strong> Connecting multiple outputs (Lights/Sound) across the same two columns. This lets them all run at full power from the same source.</li>
                                                <li><strong>Series:</strong> (Advanced) Outputs are chained from column to column. This splits the power, often dimming the lights, but is useful for complex switches.</li>
                                            </ul>
                                        </div>
                                   </div>
                               </div>
                           </div>
                       )}
                   </div>
               </div>
            </div>
          )}

          {/* --- WORKBENCH SCREEN --- */}
          {screen === 'workbench' && currentStage && (
            <div className="flex-1 flex flex-col md:flex-row overflow-hidden bg-slate-900">
               
               <Sparky 
                    mood={success ? 'excited' : (isRunning ? 'speaking' : 'happy')}
                    message={sparkyMsg}
                    mobileCollapsed={false}
                    onHint={handleHint}
                    isWorkbench={true} 
                    isVisible={isSparkyVisible || window.innerWidth >= 768} 
                />

                {/* Mobile Sparky Toggle */}
                <button 
                    onClick={() => setIsSparkyVisible(prev => !prev)}
                    className="fixed bottom-4 left-4 md:hidden z-50 p-3 rounded-full shadow-lg font-bold text-xs bg-slate-800 text-blue-400 border border-blue-500/30 backdrop-blur-md"
                >
                    {isSparkyVisible ? 'Hide AI' : 'Show AI'}
                </button>

                {/* Mission/Status Sidebar (Collapsible on Mobile) */}
                <div className={`w-full md:w-80 bg-slate-800 border-r border-slate-700 flex flex-col shrink-0 z-20 ${showMissionDetails ? 'h-auto' : 'h-auto'}`}>
                    <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                         <button onClick={() => setScreen('mission-select')} className="text-xs font-bold text-slate-400 hover:text-white flex items-center gap-1"><ArrowRight className="rotate-180" size={14}/> EXIT</button>
                         <h3 className="font-bold text-white text-sm tracking-wider">MISSION {currentMission.id}</h3>
                    </div>
                    
                    <div className="p-6 overflow-y-auto flex-1">
                        <div className="mb-6">
                            <h2 className="text-2xl font-black text-white mb-1">{currentMission.title}</h2>
                            <p className="text-xs font-bold text-blue-500 uppercase tracking-widest">Level {activeStageIndex + 1} / {currentMission.stages.length}</p>
                        </div>

                        <div className="bg-slate-700/50 p-4 rounded-xl border border-slate-600 mb-4">
                            <p className="text-sm text-slate-200 font-medium leading-relaxed">{currentStage.description}</p>
                        </div>

                        {currentStage.requiredComponents && renderRequiredComponents(currentStage.requiredComponents, components)}
                        
                        <div className="mt-6 pt-6 border-t border-slate-700">
                             <div className="flex items-center gap-2 text-slate-400 text-xs font-bold mb-2 uppercase tracking-widest">
                                <Star size={14} /> Objective
                             </div>
                             <p className="text-xs text-slate-300">{currentStage.challenge}</p>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="p-4 border-t border-slate-700 bg-slate-800/50 flex flex-col gap-2">
                        <button onClick={loadSolution} className="w-full py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold rounded-lg transition-all flex items-center justify-center gap-2 text-sm"><HelpCircle size={16}/> Reveal Schematic</button>
                        
                        {/* Show Next Level button here if success, otherwise standard controls */}
                        {success && (
                             activeStageIndex < currentMission.stages.length - 1 ? (
                                <button onClick={handleNextStage} className="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-lg shadow-green-900/20 transition-all flex items-center justify-center gap-2 animate-pulse mt-2">Next Level <ArrowRight size={18}/></button>
                             ) : (
                                <div className="w-full py-3 bg-green-500/20 border border-green-500 text-green-400 font-bold rounded-lg text-center mt-2">MISSION COMPLETE</div>
                             )
                        )}
                        
                         {/* Retry / Clear always available */}
                        <button onClick={handleTryItYourself} className="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-2 text-sm"><RefreshCcw size={16}/> Restart Level</button>
                    </div>
                </div>

                {/* Main Workspace */}
                <div className="flex-1 flex flex-col relative bg-slate-900 overflow-hidden">
                    <div className="flex-1 overflow-auto p-4 md:p-8 flex flex-col items-center">
                        
                        {/* Breadboard Container */}
                        <div className="relative p-4 bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 mb-8">
                            <div className="absolute -top-3 left-4 bg-slate-700 px-2 py-1 rounded text-[10px] font-bold text-slate-400 uppercase tracking-widest">Felt Breadboard</div>
                            {/* Scroll wrapper for small screens */}
                            <div className="overflow-auto max-w-full mobile-scroll-x">
                                <div 
                                    className="relative rounded-lg shadow-inner mx-auto"
                                    style={{
                                        width: GRID_COLS * STRIDE + GAP_SIZE,
                                        height: GRID_ROWS * STRIDE + GAP_SIZE,
                                        padding: GAP_SIZE / 2,
                                        backgroundImage: FELT_GRID_BG_URI,
                                        backgroundSize: 'cover',
                                        backgroundColor: '#64748b', // Felt Grey
                                        border: '2px solid #475569'
                                    }}
                                >
                                    {/* Conductive Lines Visualization */}
                                    {Array.from({ length: GRID_COLS }).map((_, c) => {
                                        const SNAP_GLOBAL_OFFSET_X = 15.5; 
                                        // Line centered in GAP:
                                        const CONDUCTIVE_LINE_LEFT = c * STRIDE + CELL_SIZE + (GAP_SIZE / 2) - 2.5 + SNAP_GLOBAL_OFFSET_X;
                                        return (
                                            <div key={`line-${c}`} className="absolute top-0 h-full w-[5px] opacity-20 pointer-events-none" style={{ left: CONDUCTIVE_LINE_LEFT }}>
                                                <div className="w-full h-full border-l-2 border-dashed border-blue-400"></div>
                                            </div>
                                        );
                                    })}

                                    {/* Snaps */}
                                    {Array.from({ length: GRID_ROWS }).map((_, r) =>
                                        Array.from({ length: GRID_COLS }).map((_, c) => {
                                            const SNAP_GLOBAL_OFFSET_X = 15.5; 
                                            return (
                                                <div
                                                    key={`${r}-${c}`}
                                                    className="absolute rounded-full cursor-pointer transition-transform hover:scale-110 z-10"
                                                    style={{
                                                        left: c * STRIDE + GAP_SIZE / 2 + SNAP_GLOBAL_OFFSET_X, 
                                                        top: r * STRIDE + GAP_SIZE / 2,
                                                        width: CELL_SIZE, 
                                                        height: CELL_SIZE,
                                                        backgroundColor: '#94a3b8', 
                                                        border: '2px solid #475569',
                                                        boxShadow: 'inset 0 1px 2px rgba(255,255,255,0.3), 0 2px 4px rgba(0,0,0,0.2)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center'
                                                    }}
                                                    onClick={() => handleSnapClick(r, c)}
                                                >
                                                    <div className="w-2 h-2 bg-slate-800 rounded-full shadow-inner border border-slate-600 opacity-60"></div>
                                                </div>
                                            );
                                        })
                                    )}
                                    
                                    {/* Components */}
                                    {components.map(comp => {
                                        const tool = COMPONENT_TYPES[comp.type.toUpperCase()];
                                        const SNAP_GLOBAL_OFFSET_X = 15.5;
                                        
                                        const x1 = comp.c1 * STRIDE + GAP_SIZE / 2 + SNAP_GLOBAL_OFFSET_X + CELL_SIZE / 2;
                                        const y1 = comp.r1 * STRIDE + GAP_SIZE / 2 + CELL_SIZE / 2;
                                        const x2 = comp.c2 * STRIDE + GAP_SIZE / 2 + SNAP_GLOBAL_OFFSET_X + CELL_SIZE / 2;
                                        const y2 = comp.r2 * STRIDE + GAP_SIZE / 2 + CELL_SIZE / 2;
                                        
                                        // Start at center of leftmost snap
                                        const startX = x1; 
                                        const startY = (y1 - STRIDE / 2) + 12.5; 

                                        const isActive = comp.active && isRunning;

                                        if (tool.width === 'fixed') {
                                            return (
                                                <div
                                                    key={comp.id}
                                                    className={`absolute cursor-pointer transition-all duration-200 z-20 ${isActive ? 'brightness-125 drop-shadow-[0_0_8px_rgba(59,130,246,0.8)]' : 'hover:brightness-110'}`}
                                                    style={{
                                                        left: startX, top: startY, width: STRIDE, height: STRIDE,
                                                        animation: isActive && (comp.type === 'led' || comp.type === 'sound') ? 'vibrate 0.2s infinite' : 'none'
                                                    }}
                                                    onClick={() => handleRemoveComponent(comp.id)}
                                                >
                                                    <div className={isActive && comp.type === 'led' ? 'animate-blink-fast' : ''}>
                                                        <tool.CustomIcon />
                                                    </div>
                                                </div>
                                            );
                                        } else {
                                            // Flexible Wire Logic
                                            const dx = x2 - x1, dy = y2 - y1;
                                            const dist = Math.sqrt(dx*dx + dy*dy);
                                            const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                                            const midX = (x1 + x2) / 2, midY = (y1 + y2) / 2;
                                            
                                            return (
                                                <div
                                                    key={comp.id}
                                                    className={`absolute cursor-pointer transition-all z-20 ${isActive ? 'brightness-125 drop-shadow-[0_0_5px_rgba(96,165,250,0.8)]' : ''}`}
                                                    style={{
                                                        left: midX - Math.max(dist, 10) / 2,
                                                        top: midY - 15,
                                                        width: Math.max(dist, 10),
                                                        height: 30,
                                                        transform: `rotate(${angle}deg)`,
                                                        transformOrigin: 'center center',
                                                    }}
                                                    onClick={() => handleRemoveComponent(comp.id)}
                                                >
                                                     <svg width={Math.max(dist, 10)} height="30" viewBox={`0 0 ${Math.max(dist, 10)} 30`} className="w-full h-full">
                                                        <rect x="0" y="10" width={Math.max(dist, 10)} height="10" rx="5" fill={isActive ? "#60A5FA" : "#3B82F6"} stroke="#1e40af" strokeWidth="2" />
                                                        {isActive && <path d={`M 5 15 L ${Math.max(dist, 10)-5} 15`} stroke="white" strokeDasharray="4" className="animate-pulse" />}
                                                    </svg>
                                                </div>
                                            );
                                        }
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="flex gap-4 w-full max-w-lg justify-center">
                             {currentStage.requiredComponents.button ? (
                                <button 
                                    onClick={toggleButtonPress}
                                    className={`flex-1 py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2 ${isButtonPressed ? 'bg-red-600 text-white shadow-red-900/50 ring-2 ring-red-400' : 'bg-red-500 text-white hover:bg-red-400'}`}
                                >
                                    <div className={`w-4 h-4 rounded-full ${isButtonPressed ? 'bg-white' : 'bg-red-800'}`}></div>
                                    {isButtonPressed ? 'RELEASE' : 'PRESS BUTTON'}
                                </button>
                             ) : (
                                <button 
                                    onClick={handleAutoSimulation}
                                    disabled={isRunning}
                                    className={`flex-1 py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2 ${isRunning ? 'bg-green-600 text-white' : 'bg-green-500 text-white hover:bg-green-400'}`}
                                >
                                    <Zap fill="currentColor" /> {isRunning ? 'TESTING...' : 'POWER ON'}
                                </button>
                             )}
                             
                             <button onClick={clearBoard} className="px-6 py-4 rounded-xl bg-slate-700 text-slate-300 font-bold hover:bg-slate-600 transition-colors flex items-center gap-2">
                                <Trash2 size={20}/>
                             </button>
                        </div>
                    </div>
                    
                    {/* Inventory (Parts Kit) */}
                    <div className="bg-slate-800 border-t border-slate-700 p-4 shrink-0 z-10">
                        <div className="max-w-4xl mx-auto">
                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2 ml-2">Component Inventory</p>
                            <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide mobile-scroll-x">
                                {Object.keys(COMPONENT_TYPES).map(key => {
                                    const comp = COMPONENT_TYPES[key];
                                    const isSelected = selectedTool === comp.id;
                                    return (
                                        <button
                                            key={comp.id}
                                            onClick={() => setSelectedTool(selectedTool === comp.id ? null : comp.id)}
                                            className={`flex flex-col items-center justify-center w-20 h-20 rounded-xl border-2 transition-all shrink-0 ${isSelected ? 'bg-blue-600/20 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : 'bg-slate-700 border-slate-600 hover:border-slate-500'}`}
                                        >
                                            <div className="w-12 h-12 mb-1"><comp.CustomIcon /></div>
                                            <span className="text-[10px] font-bold text-slate-300 uppercase">{comp.label}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          )}
        </div>
      );
    }

    // --- Render the Application ---
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
