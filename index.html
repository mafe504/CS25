import React, { useState, useEffect, useRef } from 'react';
import { Play, RefreshCcw, CheckCircle, HelpCircle, ArrowRight, Star, Home, Trash2, Volume2, VolumeX, ChevronDown, ChevronUp, BookOpen, Info, Lightbulb, Lock, Sparkles, Users, FileText, Cpu, Scissors, RotateCw, Shirt, Zap, Aperture, Ghost } from 'lucide-react';

/**
 * CIRCUIT STORIES - FINAL CONTENT FIX
 * * Updates:
 * - VISUAL Rework: Grid dimensions and dot placement adjusted to visually match the uploaded image's breadboard-like structure (9 vertical lanes, continuous top/bottom rails).
 * - NEW FEATURE: Added subtle vertical dashed lines to explicitly show the **Column-Based Connectivity Logic** (conductive strips) to the user.
 * - LOGIC FIX: Hardened the `runSimulation` and `toggleButtonPress` functions to ensure accurate calculation of active components immediately after the button state changes, fixing the persistent 'open circuit' issue for Mission 5.
 * - UI FIX: Moved "Test Circuit" and "Clear Board" buttons directly under the breadboard for immediate access.
 * - UI FIX: Fixed Sparky's visibility on the workbench. It is now anchored to a fixed position (bottom-32, left of the sidebar) on desktop to prevent overlap with the parts bar and prevent being rendered outside the screen boundaries.
 * - **GRAPHICS ENHANCEMENT (MAGIC):** Applied consistent, dynamic, and high-energy graphics across ALL screens (Landing, Mission Select, Manual, Workbench) using glows, pulses, and elevated UI elements.
 * - **LANDING PAGE BACKGROUND:** Changed the landing page background from a dark, hard circuit look to a magical, cosmic, and game-inspired environment with floating animated glyphs.
 * - **CREDITS ENHANCEMENT:** Updated Credits Modal: Removed individual roles and institutional graphs/logos, keeping only the developer names.
 * - **PROJECT BRIEF FIX:** Removed the T519 source attribution line.
 * - **SEWING TUTORIAL FIX:** Added SVG visualization of the sewing process with a needle and thread animation progressing through the steps.
 * - **RESPONSIVENESS FIX:** Enhanced mobile friendliness across all screens, ensuring elements stack correctly and the workbench prioritizes breadboard visibility.
 * - **GITHUB PAGES FIX (FINAL):** Removed ALL external image references by converting visual assets (felt board grid, cover image, mock avatars) to inline SVGs or data URIs, making the application 100% self-contained.
 * - **ERROR FIX:** Moved helper function declarations inside the `SewingSimulator` component scope to resolve "is not defined" errors.
 */

// --- Constants & Data ---

const GRID_ROWS = 6;
const GRID_COLS = 10; // Increased columns to simulate wider board/space for 9 lanes
const CELL_SIZE = 30; // px (Reduced for smaller snap appearance)
const GAP_SIZE = 15;  // px (Reduced gap between snaps)
const STRIDE = CELL_SIZE + GAP_SIZE; // 45px pitch

// --- SVG Assets (100% Self-Contained) ---

// 1. Felt Grid SVG Data URI (Used for Workbench Background)
const generateFeltGridSvg = (rows, cols, stride, size) => {
    const totalWidth = cols * stride + GAP_SIZE;
    const totalHeight = rows * stride + GAP_SIZE;
    let circles = '';

    // Loop through the snap positions
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            const cx = c * stride + size / 2 + GAP_SIZE / 2;
            const cy = r * stride + size / 2 + GAP_SIZE / 2;
            circles += `<circle cx="${cx}" cy="${cy}" r="3" fill="#888" opacity="0.6"/>`;
        }
    }

    const svgContent = `
        <svg width="${totalWidth}" height="${totalHeight}" viewBox="0 0 ${totalWidth} ${totalHeight}" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#f8f8f8"/>
            <rect x="5" y="5" width="${totalWidth - 10}" height="${totalHeight - 10}" rx="10" fill="#ededed" stroke="#ccc" stroke-width="2"/>
            ${circles}
        </svg>
    `.replace(/\s+/g, ' ').trim(); // Minify SVG for data URI

    return `url("data:image/svg+xml;base64,${btoa(svgContent)}")`;
};

const FELT_GRID_BG_URI = generateFeltGridSvg(GRID_ROWS, GRID_COLS, STRIDE, CELL_SIZE);

// 2. Mock Avatars (Kept Placeholder URLs, now protocol-agnostic, as requested previously)
const MOCK_AVATAR_1 = "//placehold.co/100x100/3b82f6/ffffff?text=DK";
const MOCK_AVATAR_2 = "//placehold.co/100x100/10b981/ffffff?text=MAH";
const MOCK_AVATAR_3 = "//placehold.co/100x100/f59e0b/ffffff?text=JLH";

// Array of icons for the magical background
const BACKGROUND_ICONS = [Sparkles, Star, Zap, Aperture, Ghost, Lightbulb];
const BG_ICON_COUNT = 15;


// --- Realistic Custom Icons (SVG Components) ---
// (Icons kept same as previous steps for brevity, they are working well)
const BatteryIcon = () => (
  <svg viewBox="0 0 100 60" className="w-full h-full drop-shadow-md">
    <defs>
      <linearGradient id="greenGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stopColor="#4ade80" />
        <stop offset="100%" stopColor="#22c55e" />
      </linearGradient>
    </defs>
    <rect x="5" y="5" width="90" height="50" rx="8" fill="url(#greenGrad)" stroke="#16a34a" strokeWidth="2" />
    <path d="M10 10 H90 Q92 10 92 12 V25 Q50 35 8 25 V12 Q8 10 10 10" fill="white" opacity="0.2" />
    <path d="M45 15 L60 15 L60 28 L45 28 Z" fill="#e2e8f0" opacity="0.5" /> 
    <path d="M55 22 L42 42 L52 42 L48 55 L65 35 L55 35 Z" fill="white" filter="drop-shadow(0 2px 2px rgba(0,0,0,0.2))" />
    <circle cx="15" cy="30" r="5" fill="#cbd5e1" stroke="#94a3b8" strokeWidth="2" />
    <circle cx="85" cy="30" r="5" fill="#cbd5e1" stroke="#94a3b8" strokeWidth="2" />
  </svg>
);

const WireIcon = () => (
  <svg viewBox="0 0 100 40" className="w-full h-full drop-shadow-sm">
    <defs>
      <linearGradient id="blueGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stopColor="#60a5fa" />
        <stop offset="100%" stopColor="#3b82f6" />
      </linearGradient>
    </defs>
    <rect x="5" y="10" width="90" height="20" rx="10" fill="url(#blueGrad)" stroke="#1d4ed8" strokeWidth="1" />
    <line x1="15" y1="20" x2="85" y2="20" stroke="white" strokeWidth="2" strokeDasharray="6 4" opacity="0.9" />
    <circle cx="15" cy="20" r="4" fill="white" stroke="#1e40af" strokeWidth="1" />
    <circle cx="85" cy="20" r="4" fill="white" stroke="#1e40af" strokeWidth="1" />
  </svg>
);

const ButtonIcon = () => (
  <svg viewBox="0 0 100 60" className="w-full h-full drop-shadow-md">
    <defs>
      <linearGradient id="redGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stopColor="#f87171" />
        <stop offset="100%" stopColor="#ef4444" />
      </linearGradient>
      <radialGradient id="btnGrad" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stopColor="#fee2e2" />
        <stop offset="100%" stopColor="#fca5a5" />
      </radialGradient>
    </defs>
    <rect x="5" y="5" width="90" height="50" rx="8" fill="url(#redGrad)" stroke="#dc2626" strokeWidth="2" />
    <path d="M10 10 H90 Q92 10 92 12 V20 Q50 30 8 20 V12 Q8 10 10 10" fill="white" opacity="0.2" />
    <circle cx="50" cy="30" r="18" fill="#b91c1c" />
    <circle cx="50" cy="28" r="14" fill="url(#btnGrad)" stroke="#991b1b" strokeWidth="1" />
    <path d="M20 30 L28 24 M20 30 L28 36" stroke="white" strokeWidth="3" strokeLinecap="round" opacity="0.8" />
    <path d="M80 30 L72 24 M80 30 L72 36" stroke="white" strokeWidth="3" strokeLinecap="round" opacity="0.8" />
    <circle cx="15" cy="30" r="4" fill="#cbd5e1" stroke="#94a3b8" />
    <circle cx="85" cy="30" r="4" fill="#cbd5e1" stroke="#94a3b8" />
  </svg>
);

const BuzzerIcon = () => (
  <svg viewBox="0 0 100 60" className="w-full h-full drop-shadow-md">
    <defs>
      <linearGradient id="orangeGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stopColor="#fb923c" />
        <stop offset="100%" stopColor="#f97316" />
      </linearGradient>
    </defs>
    <rect x="5" y="5" width="90" height="50" rx="8" fill="url(#orangeGrad)" stroke="#ea580c" strokeWidth="2" />
    <path d="M10 10 H90 Q92 10 92 12 V20 Q50 30 8 20 V12 Q8 10 10 10" fill="white" opacity="0.2" />
    <circle cx="50" cy="30" r="16" fill="#c2410c" />
    <circle cx="50" cy="30" r="12" fill="#292524" opacity="0.3" />
    <path d="M40 30 H60 M50 20 V40" stroke="#fb923c" strokeWidth="2" opacity="0.5" />
    <path d="M72 20 Q80 30 72 40" stroke="white" strokeWidth="3" fill="none" strokeLinecap="round" opacity="0.9" />
    <path d="M28 20 Q20 30 28 40" stroke="white" strokeWidth="3" fill="none" strokeLinecap="round" opacity="0.9" />
    <circle cx="15" cy="30" r="4" fill="#cbd5e1" stroke="#94a3b8" />
    <circle cx="85" cy="30" r="4" fill="#cbd5e1" stroke="#94a3b8" />
  </svg>
);

const LightIcon = () => (
  <svg viewBox="0 0 100 60" className="w-full h-full drop-shadow-md">
    <defs>
      <linearGradient id="yellowGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stopColor="#facc15" />
        <stop offset="100%" stopColor="#eab308" />
      </linearGradient>
      <radialGradient id="bulbGrad" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stopColor="#fef08a" />
        <stop offset="100%" stopColor="#fde047" />
      </radialGradient>
    </defs>
    <rect x="5" y="5" width="90" height="50" rx="8" fill="url(#yellowGrad)" stroke="#ca8a04" strokeWidth="2" />
    <path d="M10 10 H90 Q92 10 92 12 V20 Q50 30 8 20 V12 Q8 10 10 10" fill="white" opacity="0.3" />
    <circle cx="50" cy="30" r="14" fill="url(#bulbGrad)" stroke="#eab308" strokeWidth="1" filter="drop-shadow(0 0 5px rgba(253, 224, 71, 0.6))" />
    <circle cx="55" cy="25" r="4" fill="white" opacity="0.8" />
    <circle cx="25" cy="30" r="3" fill="white" opacity="0.5" />
    <circle cx="75" cy="30" r="3" fill="white" opacity="0.5" />
    <circle cx="15" cy="30" r="4" fill="#cbd5e1" stroke="#94a3b8" />
    <circle cx="85" cy="30" r="4" fill="#cbd5e1" stroke="#94a3b8" />
  </svg>
);

const COMPONENT_TYPES = {
  BATTERY: { 
    id: 'battery', label: 'Battery', 
    CustomIcon: BatteryIcon, 
    color: 'bg-green-500', logic: 'power', width: 'fixed',
    desc: "This is the power source for your whole project. It gives your circuit the energy it needs to light up or make sound."
  },
  CONNECTOR: { 
    id: 'connector', label: 'Wire', 
    CustomIcon: WireIcon, 
    color: 'bg-blue-400', logic: 'wire', width: 'flex',
    desc: "These pieces act like roads that electricity can travel on. They connect one part of your circuit to another."
  },
  BUTTON: { 
    id: 'button', label: 'Button', 
    CustomIcon: ButtonIcon, 
    color: 'bg-red-500', logic: 'switch', width: 'fixed',
    desc: "This is your on/off switch! When you press the button, it closes the circuit and lets electricity flow."
  },
  BUZZER: { 
    id: 'buzzer', label: 'Sound', 
    CustomIcon: BuzzerIcon, 
    color: 'bg-orange-500', logic: 'output', width: 'fixed',
    desc: "This piece makes noise when the circuit is complete. It might beep, buzz, or make a fun sound depending on your design."
  },
  LED: { 
    id: 'led', label: 'Light', 
    CustomIcon: LightIcon, 
    color: 'bg-yellow-400', logic: 'output', width: 'fixed',
    desc: "This piece lights up when your circuit is correct. It's great for making glowing eyes, warning lights, or signals."
  },
};

const MISSIONS = [
  {
    id: 1,
    title: "The Deep-Sea Mission",
    theme: "ocean",
    image: "ðŸŒŠ",
    stages: [
      {
        description: "Your submarine's search beam is out! Bridge the gap to make the light shine.",
        challenge: "Connect a Battery and a Light in parallel (bridging the same columns).",
        hint: "Try placing the Battery on the top row and the Light further down, connecting to the same columns.",
        requiredComponents: { battery: 1, led: 1 },
        // Solution: Simple parallel circuit (Col 1 to Col 2)
        solutionComponents: [
          { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
          { r1: 4, c1: 1, r2: 4, c2: 2, type: 'led' }
        ]
      }
    ]
  },
  {
    id: 2,
    title: "Robo-City Power Outage",
    theme: "city", 
    image: "ðŸ™ï¸",
    stages: [
      {
        description: "Robo-City's streetlights have gone dark! Build a simple circuit to power two streetlights at once.",
        challenge: "Use 2 lights on one power source to relight the city.",
        hint: "You can stack lights vertically! Connect them all to the same power columns.",
        requiredComponents: { battery: 1, led: 2 },
        // Solution: Two LEDs in parallel (Col 1 to Col 2)
        solutionComponents: [
          { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
          { r1: 3, c1: 1, r2: 3, c2: 2, type: 'led' },
          { r1: 5, c1: 1, r2: 5, c2: 2, type: 'led' }
        ]
      }
    ]
  },
  {
    id: 3,
    title: "The Midnight Circus",
    theme: "circus", 
    image: "ðŸŽª",
    stages: [
      {
        description: "A magic gust knocked out the spotlight and drumroll. Build a circuit that turns on a light and buzzer together.",
        challenge: "Use 1 light + 1 buzzer to power the opening act.",
        hint: "Just like the streetlights, but swap one light for a buzzer!",
        requiredComponents: { battery: 1, buzzer: 1, led: 1 },
        // Solution: LED and Buzzer in parallel (Col 1 to Col 2)
        solutionComponents: [
          { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
          { r1: 3, c1: 1, r2: 3, c2: 2, type: 'led' },
          { r1: 5, c1: 1, r2: 5, c2: 2, type: 'buzzer' }
        ]
      }
    ]
  },
  {
    id: 4,
    title: "Game Master Challenge",
    theme: "arcade",
    image: "ðŸŽ®",
    stages: [
      {
        description: "Pixel monsters! The buzzer is too far from the battery return. Use a long flexible wire!",
        challenge: "Use 1 buzzer + 1 button + 1 Long Wire.",
        hint: "The blue Wire acts like a bridge. Use it to connect the end of the circuit back to the start.",
        requiredComponents: { battery: 1, buzzer: 1, button: 1, connector: 1 },
        // Solution: Series circuit using four columns and a wire jumper (Col 2 -> 3 -> 4 -> 1)
        solutionComponents: [
          { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
          { r1: 3, c1: 2, r2: 3, c2: 3, type: 'button' },
          { r1: 5, c1: 3, r2: 5, c2: 4, type: 'buzzer' },
          { r1: 0, c1: 4, r2: 0, c2: 1, type: 'connector' } 
        ]
      }
    ]
  },
  {
    id: 5,
    title: "The Haunted House",
    theme: "spooky",
    image: "ðŸ‘»",
    stages: [
      {
        description: "The doorbell is broken! Visitors can't ring it.",
        challenge: "Level 1: Build a simple doorbell using a Battery, Button, and Buzzer.",
        hint: "Power -> Button -> Buzzer. Make sure to use a Wire to close the loop if needed!",
        requiredComponents: { battery: 1, button: 1, buzzer: 1 },
        // Solution: Series circuit (Col 2 -> 3 -> 4 -> 1)
        solutionComponents: [
          { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
          { r1: 3, c1: 2, r2: 3, c2: 3, type: 'button' },
          { r1: 5, c1: 3, r2: 5, c2: 4, type: 'buzzer' },
          { r1: 0, c1: 4, r2: 0, c2: 1, type: 'connector' } 
        ]
      },
      {
        description: "Great! Now fix the porch light too. It needs to turn on when the doorbell rings.",
        challenge: "Level 2: Add a Light to your circuit so both the buzzer AND light work together.",
        hint: "Add the light right next to the buzzer on the same columns.",
        requiredComponents: { battery: 1, button: 1, buzzer: 1, led: 1 },
        // Solution: Series circuit (Col 2 -> 3), Parallel outputs (Col 3 -> 4), Jumper (Col 4 -> 1)
        solutionComponents: [
          { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
          { r1: 3, c1: 2, r2: 3, c2: 3, type: 'button' },
          { r1: 5, c1: 3, r2: 5, c2: 4, type: 'buzzer' },
          { r1: 4, c1: 3, r2: 4, c2: 4, type: 'led' }, 
          { r1: 0, c1: 4, r2: 0, c2: 1, type: 'connector' }
        ]
      }
    ]
  },
  {
    id: 6,
    title: "Robo-Dance Party",
    theme: "lab", 
    image: "ðŸ¤–",
    stages: [
      {
        description: "Let's get this party started! We need music.",
        challenge: "Level 1: Connect a Battery to a Buzzer to start the beat.",
        hint: "Just a simple loop: Battery and Buzzer connecting the same two columns.",
        requiredComponents: { battery: 1, buzzer: 1 },
        // Solution: Simple parallel circuit (Col 1 to Col 2)
        solutionComponents: [
          { r1: 1, c1: 1, r2: 1, c2: 2, type: 'battery' },
          { r1: 4, c1: 1, r2: 4, c2: 2, type: 'buzzer' }
        ]
      }
    ]
  }
];

// --- Audio Engine ---
const playSound = (type) => {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    const now = ctx.currentTime;

    switch (type) {
      case 'snap': 
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.05);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
        osc.start(now);
        osc.stop(now + 0.05);
        break;
      case 'pop':
        osc.type = 'sine';
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.linearRampToValueAtTime(600, now + 0.05);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
        osc.start(now);
        osc.stop(now + 0.05);
        break;
      case 'success': 
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523.25, now); 
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.2);
        osc.start(now);
        osc.stop(now + 0.2);
        break;
      case 'error':
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.linearRampToValueAtTime(100, now + 0.4);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.4);
        osc.start(now);
        osc.stop(now + 0.4);
        break;
      case 'click':
        osc.type = 'square';
        osc.frequency.setValueAtTime(200, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
        osc.start(now);
        osc.stop(now + 0.05);
        break;
      case 'buzz': // NEW: Continuous buzzing sound
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(80, now); // Low buzz
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.5);
        osc.start(now);
        osc.stop(now + 0.5);
        break;
      default: break;
    }
  } catch (e) { console.error("Audio error", e); }
};

// --- Helper Functions ---
const getThemeColors = (theme) => {
  switch (theme) {
    case 'ocean': return 'from-blue-200 to-blue-100 text-blue-800';
    case 'lab': return 'from-indigo-200 to-indigo-100 text-indigo-800';
    case 'cave': return 'from-stone-300 to-stone-200 text-stone-800';
    case 'arcade': return 'from-purple-200 to-purple-100 text-purple-800';
    case 'city': return 'from-slate-300 to-slate-200 text-slate-800';
    case 'circus': return 'from-red-200 to-orange-100 text-red-800';
    case 'spooky': return 'from-gray-300 to-gray-200 text-gray-800';
    case 'magazine': return 'from-teal-200 to-cyan-100 text-teal-800'; 
    default: return 'from-slate-200 to-slate-100 text-slate-800';
  }
};

// --- Sparky Component ---
const Sparky = ({ mood = 'happy', message, mobileCollapsed, onHint, isWorkbench }) => {
  if (mobileCollapsed || (isWorkbench && window.innerWidth < 768)) {
    // Hide Sparky entirely on mobile workbench for space efficiency
     return null; 
  }

  const isExcited = mood === 'excited';
  const isSpeaking = mood === 'speaking';

  const styles = `
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    @keyframes blink {
      0%, 90%, 100% { transform: scaleY(1); }
      95% { transform: scaleY(0.1); }
    }
    @keyframes talk {
      0%, 100% { height: 4px; }
      50% { height: 12px; }
    }
    @keyframes vibrate {
        0%, 100% { transform: translate(1px, 1px); }
        25% { transform: translate(-1px, -1px); }
        50% { transform: translate(1px, -1px); }
        75% { transform: translate(-1px, 1px); }
    }
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .sparky-float { animation: float 3s ease-in-out infinite; }
    .sparky-eyes { animation: blink 4s infinite; transform-origin: center; }
    .sparky-mouth { animation: talk 0.2s infinite; transform-origin: center; }
    .animate-vibrate { animation: vibrate 0.1s infinite; }
    .animate-blink { animation: blink 1s infinite; }
    .message-bubble {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 15px rgba(59, 130, 246, 0.4); /* Blue glow shadow */
    }
  `;

  // Dynamic positioning: Fixed on landing page.
  // On workbench (isWorkbench=true): Fixed to the LEFT side,
  // lifted higher (bottom-32 on desktop) to clear the control bar.
  const baseClasses = isWorkbench 
    ? "fixed hidden md:flex flex-col items-end left-2 bottom-32 z-50 pointer-events-none"
    : "fixed bottom-24 right-4 md:bottom-6 md:left-6 z-50 flex flex-col-reverse md:flex-row items-end pointer-events-none";

  // Message box alignment depends on where the robot is (left vs right)
  const messageBoxClasses = isWorkbench
    ? "relative transition-all duration-300 md:order-1 ml-auto mr-4" // Message box on the LEFT of the robot
    : "relative md:mr-4 ml-auto md:ml-0 transition-all duration-300";

  return (
    <div className={baseClasses}>
      <style>{styles}</style>
      <div className={`relative ${messageBoxClasses}`}>
        
        {/* HINT BULB BUTTON - NOW ON ROBOT */}
        {onHint && (
            <button 
                onClick={onHint}
                className="absolute -top-12 right-1/2 translate-x-1/2 bg-yellow-400 hover:bg-yellow-300 text-yellow-900 p-3 rounded-full shadow-lg animate-bounce cursor-pointer pointer-events-auto border-2 border-white z-50 ring-4 ring-yellow-200/50"
                title="Need a hint? Click me!"
            >
                <Lightbulb size={24} fill="currentColor" />
            </button>
        )}

        <div className="w-28 h-32 md:w-36 md:h-40 sparky-float">
            <svg viewBox="0 0 200 220" className="w-full h-full drop-shadow-2xl">
            <defs>
                <linearGradient id="bodyGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stopColor="#60A5FA" />
                <stop offset="100%" stopColor="#2563EB" />
                </linearGradient>
                <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="4" result="blur" />
                <feComposite in="SourceGraphic" in2="blur" operator="over" />
                </filter>
            </defs>
            <line x1="100" y1="40" x2="100" y2="10" stroke="#94A3B8" strokeWidth="6" strokeLinecap="round" />
            <circle cx="100" cy="10" r="8" fill={isExcited ? "#EF4444" : "#F87171"} className={isExcited ? "animate-pulse" : ""} />
            <path d="M 35 120 Q 20 130 35 140" stroke="#3B82F6" strokeWidth="8" strokeLinecap="round" fill="none" />
            <path d="M 165 120 Q 180 130 165 140" stroke="#3B82F6" strokeWidth="8" strokeLinecap="round" fill="none" />
            <rect x="40" y="40" width="120" height="110" rx="24" fill="url(#bodyGradient)" stroke="#1D4ED8" strokeWidth="3" />
            <rect x="55" y="60" width="90" height="65" rx="12" fill="#0F172A" stroke="#334155" strokeWidth="2" />
            <g className={isExcited ? "" : "sparky-eyes"}>
                <ellipse cx="75" cy="90" rx="14" ry="18" fill="#06B6D4" filter="url(#glow)" />
                <circle cx="79" cy="85" r="5" fill="white" opacity="0.9" />
                <ellipse cx="125" cy="90" rx="14" ry="18" fill="#06B6D4" filter="url(#glow)" />
                <circle cx="129" cy="85" r="5" fill="white" opacity="0.9" />
            </g>
            <g transform="translate(100, 135)">
                {isSpeaking ? (
                    <rect x="-15" y="-4" width="30" height="8" rx="4" fill="#22C55E" className="sparky-mouth" />
                ) : isExcited ? (
                    <path d="M -20 -5 Q 0 15 20 -5" stroke="#22C55E" strokeWidth="4" strokeLinecap="round" fill="none" />
                ) : (
                    <rect x="-10" y="-2" width="20" height="4" rx="2" fill="#22C55E" />
                )}
            </g>
            <path d="M 65 150 L 65 170 A 10 10 0 0 0 85 170 L 85 150 Z" fill="#1E40AF" />
            <path d="M 115 150 L 115 170 A 10 10 0 0 0 135 170 L 135 150 Z" fill="#1E40AF" />
            </svg>
        </div>
      </div>
      {message && (
        <div className={`message-bubble bg-white/95 backdrop-blur-sm text-slate-800 p-4 rounded-2xl ${isWorkbench ? 'rounded-tr-sm' : 'rounded-bl-sm'} shadow-xl max-w-[200px] md:max-w-xs border border-blue-200 mb-6 mx-4 relative pointer-events-auto transform transition-all duration-300 animate-in fade-in slide-in-from-bottom-4 md:order-2`}>
           <div className="flex items-center gap-2 mb-1 border-b border-slate-100 pb-2">
             <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
             <p className="font-extrabold text-[10px] text-slate-400 uppercase tracking-widest">SYSTEM MESSAGE</p>
           </div>
           <p className="text-sm font-medium leading-relaxed text-slate-700">{message}</p>
        </div>
      )}
    </div>
  );
};

// --- Modals ---

const Modal = ({ title, children, onClose }) => (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in">
        <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300 animate-in zoom-in-75 ring-4 ring-blue-500/10">
            <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 flex justify-between items-center rounded-t-3xl shadow-md">
                <h3 className="text-xl font-black">{title}</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-white/20 transition-colors ring-1 ring-white/50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div className="p-6 text-slate-700">
                {children}
            </div>
        </div>
    </div>
);

// --- Credit Modal (Simplified) ---
const CreditsModal = ({ onClose }) => {
    return (
        <Modal title="Project Credits" onClose={onClose}>
            <div className="text-center p-4">
                <h4 className="text-2xl font-black text-blue-800 mb-2">Circuit Stories</h4>
                <p className="text-sm text-slate-500 mb-6">Digital Fabrication and Making in Education - Fall 2025</p>
                
                <h5 className="font-extrabold text-lg text-slate-700 mb-3 uppercase tracking-wider border-b pb-2">Developed By</h5>
                <div className="grid grid-cols-3 gap-4 mb-8">
                    
                    {/* Member 1 - DK */}
                    <div className="flex flex-col items-center p-2 rounded-xl bg-blue-50 border border-blue-200 shadow-md transition-shadow hover:shadow-lg">
                        {/* Replaced img tag with inline SVG avatar */}
                        <svg viewBox="0 0 100 100" className="w-16 h-16 rounded-full border-4 border-white object-cover shadow-inner mb-2 bg-blue-400">
                             <circle cx="50" cy="50" r="48" fill="url(#avatarGrad1)" />
                             <text x="50%" y="65%" dominantBaseline="middle" textAnchor="middle" fontSize="40" fontWeight="bold" fill="#fff">DK</text>
                             <defs><linearGradient id="avatarGrad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#3b82f6" /><stop offset="100%" stopColor="#1d4ed8" /></linearGradient></defs>
                        </svg>
                        <p className="font-bold text-base text-blue-700">David Kim</p>
                    </div>

                    {/* Member 2 - MAH */}
                    <div className="flex flex-col items-center p-2 rounded-xl bg-green-50 border border-green-200 shadow-md transition-shadow hover:shadow-lg">
                        {/* Replaced img tag with inline SVG avatar */}
                         <svg viewBox="0 0 100 100" className="w-16 h-16 rounded-full border-4 border-white object-cover shadow-inner mb-2 bg-green-400">
                             <circle cx="50" cy="50" r="48" fill="url(#avatarGrad2)" />
                             <text x="50%" y="65%" dominantBaseline="middle" textAnchor="middle" fontSize="40" fontWeight="bold" fill="#fff">MAH</text>
                             <defs><linearGradient id="avatarGrad2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#10b981" /><stop offset="100%" stopColor="#059669" /></linearGradient></defs>
                        </svg>
                        <p className="font-bold text-base text-green-700">Musa Abu Hadeed</p>
                    </div>

                    {/* Member 3 - JLH */}
                    <div className="flex flex-col items-center p-2 rounded-xl bg-yellow-50 border border-yellow-200 shadow-md transition-shadow hover:shadow-lg">
                        {/* Replaced img tag with inline SVG avatar */}
                         <svg viewBox="0 0 100 100" className="w-16 h-16 rounded-full border-4 border-white object-cover shadow-inner mb-2 bg-yellow-400">
                             <circle cx="50" cy="50" r="48" fill="url(#avatarGrad3)" />
                             <text x="50%" y="65%" dominantBaseline="middle" textAnchor="middle" fontSize="40" fontWeight="bold" fill="#fff">JLH</text>
                             <defs><linearGradient id="avatarGrad3" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#f59e0b" /><stop offset="100%" stopColor="#d97706" /></linearGradient></defs>
                        </svg>
                        <p className="font-bold text-base text-yellow-700">Julie J Heck</p>
                    </div>
                </div>
                

                <p className="text-xs mt-6 text-slate-400">Harvard Graduate School of Education</p>
            </div>
        </Modal>
    );
};

const ProjectBriefModal = ({ onClose }) => (
    <Modal title="Project Idea: Circuit Stories" onClose={onClose}>
        <h4 className="text-xl font-bold text-blue-700 mb-3">Overview & Motivation</h4>
        <p className="mb-4 text-sm leading-relaxed">
            Circuit Stories is a story-based circuit kit designed for learners aged 10-12. The goal is to build a foundational understanding of simple electronic circuits in a concrete, memorable, and motivating way, moving beyond confusing paper diagrams.
        </p>
        
        <h4 className="text-xl font-bold text-blue-700 mb-3 mt-4">Learning Goals</h4>
        <ul className="list-disc list-inside space-y-2 text-sm ml-2">
            <li>Identify the four key circuit components: battery, input (button), output (light/sound), and conductor (connector).</li>
            <li>Explain the difference between open and closed circuits.</li>
            <li>Explain and build simple and complex circuits using various components.</li>
        </ul>

        <h4 className="text-xl font-bold text-blue-700 mb-3 mt-4">Learning Philosophy</h4>
        <p className="mb-4 text-sm leading-relaxed">
            Grounded in **Constructivism** (connecting new ideas to prior knowledge, e.g., cause and effect) and **Constructionism** (learning by creating meaningful, physical artifacts). The kit ensures students not only construct knowledge internally but also build functional circuits.
        </p>

        <h4 className="text-xl font-bold text-blue-700 mb-3 mt-4">Key Features</h4>
        <ul className="list-disc list-inside space-y-2 text-sm ml-2">
            <li>**Story Cards:** Provide narrative scenarios (missions) and circuit-building challenges.</li>
            <li>**Hands-On Construction:** Physical assembly of pieces that snap onto a felt grid.</li>
            <li>**Immediate Feedback:** Lights and buzzers activate instantly when circuits are correctly assembled.</li>
        </ul>
    </Modal>
);

// --- Sewing Simulator Component ---
const SewingSimulator = ({ onClose }) => {
    const [sewingStep, setSewingStep] = useState(0);
    const [isSewing, setIsSewing] = useState(false);
    const [view, setView] = useState('front'); // 'front' or 'back'

    const steps = [
        "Align the felt board on your shirt's chest area. Use pins to secure it in place.",
        "Choose a neutral sewing thread (not conductive!) that matches the felt or shirt.",
        "Starting at a corner, pull the needle through the shirt and up through the first perimeter hole.",
        "Stitch over the rounded edge and down through the second perimeter hole.",
        "Continue stitching through the perimeter holes around the entire border.",
        "When finished, tie a knot on the inside of the shirt, and cut the thread. You're ready to snap on components!"
    ];

    // --- Sewing Visual Setup ---
    const SEW_HOLES = [
        // Top edge (8 holes)
        { x: 20, y: 5 }, { x: 35, y: 5 }, { x: 50, y: 5 }, { x: 65, y: 5 }, 
        { x: 80, y: 5 }, { x: 95, y: 5 }, { x: 110, y: 5 }, { x: 125, y: 5 },
        // Right edge (4 holes)
        { x: 135, y: 25 }, { x: 135, y: 45 }, { x: 135, y: 65 }, { x: 135, y: 85 },
        // Bottom edge (8 holes)
        { x: 125, y: 95 }, { x: 110, y: 95 }, { x: 95, y: 95 }, { x: 80, y: 95 },
        { x: 65, y: 95 }, { x: 50, y: 95 }, { x: 35, y: 95 }, { x: 20, y: 95 },
        // Left edge (4 holes)
        { x: 5, y: 85 }, { x: 5, y: 65 }, { x: 5, y: 45 }, { x: 5, y: 25 },
    ];
    
    const needleTip = (step) => {
        if (step < 3) return { x: 0, y: 0 }; 
        const normalizedStep = step - 3;
        const currentHoleIndex = normalizedStep % SEW_HOLES.length;
        return SEW_HOLES[currentHoleIndex];
    };
    
    // Calculate stitch visibility (dashoffset) based on the sewing step
    const stitchLength = 400; // Estimated path length (for stroke-dasharray)
    const stitchSteps = 24; // Total number of holes in the perimeter
    let dashOffset = stitchLength;
    if (sewingStep >= 3 && sewingStep <= 5) {
        // Animate the first few stitches explicitly
        const segments = sewingStep - 2;
        dashOffset = stitchLength - (stitchLength / stitchSteps) * segments;
    } else if (sewingStep >= 6) {
        dashOffset = 0; // Complete
    }

    const currentTip = needleTip(sewingStep);

    // Style for the back of the felt board (where the thread is visible)
    const FeltBack = () => (
        <svg viewBox="0 0 140 100" className="w-full h-full object-contain drop-shadow-lg p-2">
            <rect x="10" y="10" width="120" height="80" rx="8" fill="#f0f0f0" stroke="#ccc" strokeWidth="1" filter="drop-shadow(0 0 3px rgba(0,0,0,0.1))"/>
            
            {/* Mock messy thread on the back */}
            <path d="M 50 30 Q 65 40 70 20 T 95 50 T 70 80 T 55 60 Z" stroke="#999" strokeWidth="2" fill="none" opacity="0.5"/>
            <path d="M 50 30 Q 30 50 50 70 T 90 50" stroke="#999" strokeWidth="1" fill="none" opacity="0.3"/>

            {/* Perimeter Stitching Holes (showing knots on back) */}
            {SEW_HOLES.map((p, i) => (
                <circle key={i} cx={p.x} cy={p.y} r="2" fill="#888" stroke="#555" strokeWidth="0.5" />
            ))}
        </svg>
    );

    // Style for the front of the felt board (clean template)
    const FeltFront = () => (
        <svg viewBox="0 0 140 100" className="w-full h-full object-contain drop-shadow-lg p-2">
            <rect x="10" y="10" width="120" height="80" rx="8" fill="#f0f0f0" stroke="#ccc" strokeWidth="1" filter="drop-shadow(0 0 3px rgba(0,0,0,0.1))"/>
            
            {/* Perimeter Stitching Holes (empty on front, showing where to pin) */}
            {SEW_HOLES.map((p, i) => (
                <circle key={i} cx={p.x} cy={p.y} r="1.5" fill="none" stroke="#aaa" strokeWidth="1" />
            ))}
            
            {/* Example pins showing alignment */}
            <line x1="15" y1="15" x2="15" y2="25" stroke="#f87171" strokeWidth="1" opacity={sewingStep < 2 ? 1 : 0.2}/>
            <path d="M 15 25 L 18 20 L 12 20 Z" fill="#f87171" opacity={sewingStep < 2 ? 1 : 0.2}/>
        </svg>
    );
    
    // Moved handler definitions inside the component scope (FIX for ReferenceError)
    const handleStartSewing = () => {
        setIsSewing(true);
        setSewingStep(0);
        setTimeout(() => setSewingStep(1), 500);
    };

    const handleNextStep = () => {
        if (sewingStep < steps.length - 1) {
            setSewingStep(sewingStep + 1);
        } else {
            setIsSewing(false);
            setSewingStep(steps.length);
        }
    };

    const handleReset = () => {
        setIsSewing(false);
        setSewingStep(0);
        setView('front');
    };


    return (
        <Modal title="Wearable Mode: Sewing Tutorial" onClose={onClose}>
            <style>{`
                @keyframes needle-thread {
                    0% { stroke-dashoffset: ${stitchLength}; }
                    100% { stroke-dashoffset: 0; }
                }
                .sewing-stitch {
                    stroke-dasharray: 5 20; /* Example: length of stitch segment, length of gap */
                    stroke-dashoffset: ${dashOffset};
                    transition: stroke-dashoffset 1s ease-out;
                }
            `}</style>
            <div className="flex flex-col md:flex-row gap-6">
                
                {/* Visualizer Column */}
                <div className="w-full md:w-1/2 flex flex-col items-center">
                    <div className="w-full bg-slate-100 p-4 rounded-xl shadow-inner relative aspect-square max-h-80">
                        {/* Shirt Background Placeholder */}
                        <div className="absolute inset-0 bg-blue-300/40 rounded-xl" style={{ clipPath: 'polygon(0 0, 100% 0, 80% 100%, 20% 100%)' }}></div>
                        
                        
                        {/* SVG VISUALIZATION (Dynamic based on view) */}
                        {view === 'front' ? <FeltFront /> : <FeltBack />}

                        {/* Animated Stitching Overlay (Only for front view and steps > 2) */}
                        {view === 'front' && sewingStep >= 3 && (
                             <svg viewBox="0 0 140 100" className="absolute inset-0 w-full h-full p-2 pointer-events-none">
                                {/* Stitch Path */}
                                <path 
                                    d={`M ${SEW_HOLES[0].x} ${SEW_HOLES[0].y} ` + SEW_HOLES.slice(1, 24).map(p => `L ${p.x} ${p.y}`).join(' ')}
                                    stroke="#900" 
                                    strokeWidth="1.5" 
                                    className="sewing-stitch" 
                                    fill="none" 
                                    strokeLinecap="round"
                                />

                                {/* Needle Tip (Visible during progression) */}
                                {sewingStep <= 5 && (
                                    <g transform={`translate(${currentTip.x}, ${currentTip.y}) rotate(-45)`} >
                                        <path d="M 0 0 L 10 0 L 0 30 Z" fill="#ccc" stroke="#888" strokeWidth="0.5"/>
                                        <line x1="5" y1="20" x2="5" y2="45" stroke="#900" strokeWidth="1" />
                                    </g>
                                )}
                            </svg>
                        )}


                         <div className="absolute top-2 left-2 px-3 py-1 bg-white rounded-full text-xs font-bold shadow-md text-slate-600">
                            {view === 'front' ? 'Front View (Stitching Guide)' : 'Back View (Knotting)'}
                        </div>
                    </div>

                    <button 
                        onClick={() => setView(view === 'front' ? 'back' : 'front')}
                        className="mt-4 px-4 py-2 bg-blue-500 text-white rounded-full font-bold text-sm shadow-md hover:bg-blue-600 transition-colors flex items-center gap-2 ring-2 ring-blue-300/50 hover:scale-[1.02]"
                    >
                        <RotateCw size={16} /> Flip Board View
                    </button>
                </div>

                {/* Instructions Column */}
                <div className="w-full md:w-1/2">
                    <h4 className="text-lg font-bold text-blue-600 mb-2">Step {isSewing ? sewingStep : '0'}: {isSewing ? (sewingStep < steps.length ? `Sewing the Edge` : 'Finished!') : 'Prepare'}</h4>
                    <p className={`text-sm mb-4 p-3 rounded-lg ${isSewing ? 'bg-yellow-50 text-yellow-800 border border-yellow-200 shadow-md' : 'bg-slate-50 text-slate-600 border border-slate-200 shadow-sm'}`}>
                        {isSewing && sewingStep < steps.length ? steps[sewingStep] : 
                        "Learn how to permanently attach your felt breadboard to a T-shirt using thread, making it a wearable circuit device!"}
                    </p>

                    <div className="space-y-3">
                        {isSewing && sewingStep < steps.length && (
                            <button onClick={handleNextStep} className="w-full px-4 py-3 bg-green-500 text-white rounded-xl font-bold shadow-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2 hover:scale-[1.01]">
                                <ArrowRight size={20} /> Next Step
                            </button>
                        )}
                        {sewingStep === 0 && (
                            <button onClick={handleStartSewing} className="w-full px-4 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 hover:scale-[1.01]">
                                <Shirt size={20} /> Start Sewing Tutorial
                            </button>
                        )}
                        {sewingStep > 0 && (
                            <button onClick={handleReset} className="w-full px-4 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition-colors flex items-center justify-center gap-2 hover:scale-[1.01]">
                                <RefreshCcw size={20} /> Reset Tutorial
                            </button>
                        )}
                    </div>

                    <h5 className="text-md font-bold text-slate-700 mt-6 mb-2">Materials Needed:</h5>
                    <ul className="list-disc list-inside text-sm ml-2">
                        <li>Felt Breadboard (from the kit)</li>
                        <li>T-Shirt or Fabric Item</li>
                        <li>Sewing Needle & Neutral Thread</li>
                        <li>Safety Pins (for alignment)</li>
                    </ul>
                </div>
            </div>
        </Modal>
    );
};

// --- Main App ---

export default function App() {
// ... (rest of App component remains unchanged)
  const [screen, setScreen] = useState('landing');
  const [activeMissionId, setActiveMissionId] = useState(null);
  const [activeStageIndex, setActiveStageIndex] = useState(0); 
  const [components, setComponents] = useState([]);
  const [selectedTool, setSelectedTool] = useState(null);
  const [dragStart, setDragStart] = useState(null); 
  const [showMissionDetails, setShowMissionDetails] = useState(false);
  const [audioEnabled, setAudioEnabled] = useState(true);
  const [isRunning, setIsRunning] = useState(false);
  const [isButtonPressed, setIsButtonPressed] = useState(false);
  const [success, setSuccess] = useState(false);
  const [sparkyMsg, setSparkyMsg] = useState("Hi! I'm Sparky. Let's build on the Felt Board!");
  const [manualTab, setManualTab] = useState('parts'); 
  const [isSolutionMode, setIsSolutionMode] = useState(false); 
  const [showCredits, setShowCredits] = useState(false); 
  const [showBrief, setShowBrief] = useState(false); 
  const [showSewing, setShowSewing] = useState(false); // NEW: Sewing State

  // NOTE: FELT_BOARD_IMAGE_URL was missing in the original file, replacing it with a placeholder path.
  const FELT_BOARD_IMAGE_URL = "felt_board_texture.jpg"; 


  const triggerSound = (type) => { if (audioEnabled) playSound(type); };

  const handleStartMission = (id) => {
    if (id === 'coming-soon') return; 
    setActiveMissionId(id);
    setActiveStageIndex(0); 
    setScreen('workbench');
    setComponents([]);
    setSuccess(false);
    setIsRunning(false);
    setIsSolutionMode(false); 
    setShowMissionDetails(false);
    const mission = MISSIONS.find(m => m.id === id);
    setSparkyMsg(mission.stages[0].description + (mission.stages[0].requiredComponents.button ? " Remember to PRESS the red button below to close the circuit and test!" : ""));
    triggerSound('snap');
  };

  const handleNextStage = () => {
    const mission = MISSIONS.find(m => m.id === activeMissionId);
    if (activeStageIndex < mission.stages.length - 1) {
        setActiveStageIndex(prev => prev + 1);
        setSuccess(false);
        setIsRunning(false);
        setIsSolutionMode(false); 
        setComponents(components.filter(c => c.type !== 'battery' && c.type !== 'connector' && c.type !== 'led' && c.type !== 'buzzer' && c.type !== 'button')); // Clear outputs only for multi-stage
        const nextStage = mission.stages[activeStageIndex + 1];
        setSparkyMsg(nextStage.description + (nextStage.requiredComponents.button ? " Remember to PRESS the red button below to close the circuit and test!" : ""));
        triggerSound('snap');
    }
  };

  const handleHint = () => {
    const mission = MISSIONS.find(m => m.id === activeMissionId);
    if (!mission) return;
    const hint = mission.stages[activeStageIndex].hint;
    if (hint) {
        setSparkyMsg(`HINT: ${hint}`);
        triggerSound('click');
    } else {
        setSparkyMsg("No hint available for this mission!");
    }
  };

  const handleSnapClick = (r, c) => {
    if (isRunning) return;
    if (!selectedTool) {
      setSparkyMsg("Pick a part from the kit below first!");
      return;
    }
    
    const toolInfo = COMPONENT_TYPES[selectedTool.toUpperCase()];

    if (!dragStart) {
      setDragStart({ r, c });
      if (toolInfo.width === 'flex') {
          setSparkyMsg("Click ANY other snap to connect the wire!");
      } else {
          setSparkyMsg("Select the second snap in this row (must be adjacent).");
      }
      triggerSound('snap');
    } else {
      let isValid = false;
      let r1 = dragStart.r, c1 = dragStart.c, r2 = r, c2 = c;

      if (toolInfo.width === 'fixed') {
          if (r1 !== r2) {
              setSparkyMsg("This part fits horizontally only!");
              triggerSound('error');
              setDragStart(null);
              return;
          }
          if (Math.abs(c1 - c2) !== 1) {
              setSparkyMsg("This part is size 1 (must span 2 adjacent snaps).");
              triggerSound('error');
              setDragStart(null);
              return;
          }
          isValid = true;
      } else {
          // Flexible parts (wires)
          if (r1 === r2 && c1 === c2) {
              setSparkyMsg("Connect to a different snap!");
              triggerSound('error');
              return;
          }
          isValid = true;
      }

      if (isValid) {
          const newComp = { 
              id: Date.now(), 
              type: selectedTool, 
              r1, c1, r2, c2, 
              active: false 
          };
          const newComponents = [...components, newComp];
          setComponents(newComponents);
          setSparkyMsg("Snap! Placed.");
          triggerSound('snap');
          // If a component is placed while the button is pressed, update simulation
          if (isButtonPressed) {
              updateSimulationState(true, newComponents);
          }
      }
      setDragStart(null);
    }
  };

  const handleRemoveComponent = (id) => {
    if (isRunning) return;
    const newComponents = components.filter(c => c.id !== id);
    setComponents(newComponents);
    triggerSound('pop');
    // If running a button circuit, recalculate after removal
    if (isButtonPressed) {
        updateSimulationState(true, newComponents);
    }
  };

  const loadSolution = () => {
    const mission = MISSIONS.find(m => m.id === activeMissionId);
    if (!mission) return;
    const stage = mission.stages[activeStageIndex];
    const solvedComps = stage.solutionComponents.map((sc, idx) => ({ id: `sol-${idx}`, ...sc, active: false }));
    setComponents(solvedComps);
    setSparkyMsg("Here's a working layout! Study it, then click 'Try It Yourself'.");
    triggerSound('snap');
    setIsSolutionMode(true); 
    setIsRunning(false);
    setSuccess(false);
  };

  const handleTryItYourself = () => {
    setComponents([]); // Clear board
    setIsRunning(false);
    setSuccess(false);
    setSparkyMsg("Board cleared! Now try to build it from memory.");
    triggerSound('pop');
    setIsSolutionMode(false); // Return to normal mode
    setIsButtonPressed(false);
  };

  const clearBoard = () => {
    setComponents([]);
    setIsRunning(false);
    setSuccess(false);
    setSparkyMsg("Board cleared.");
    triggerSound('pop');
    if (isSolutionMode) setIsSolutionMode(false); 
    setIsButtonPressed(false);
  };

  /**
   * Runs the column-based simulation to determine current flow.
   * @param {boolean} isCurrentlyPressed - The state of the button *at the moment of calculation*.
   * @param {Array<Object>} currentComponents - The list of components *at the moment of calculation*.
   */
  const runSimulation = (isCurrentlyPressed, currentComponents) => {
    const currentMission = MISSIONS.find(m => m.id === activeMissionId);
    if (!currentMission) return { activeComponentIds: new Set(), missionSuccess: false };
    const stage = currentMission.stages[activeStageIndex];

    // Adjacency list: Node keys are column indices (0 to GRID_COLS-1)
    const adj = {}; 
    for(let i=0; i<GRID_COLS; i++) adj[i] = [];

    let batteries = currentComponents.filter(c => c.type === 'battery');
    if (batteries.length === 0) {
      // If no battery, immediately return failure
      return { activeComponentIds: new Set(), missionSuccess: false };
    }

    // Build Adjacency List based on component connections (column to column)
    currentComponents.forEach(comp => {
      // Buttons only count if currently pressed OR if it's a fixed component (non-button)
      const isActiveSwitch = comp.type !== 'button' || isCurrentlyPressed; 

      if (isActiveSwitch) {
          const c1 = comp.c1;
          const c2 = comp.c2;
          
          adj[c1].push({ target: c2, id: comp.id, type: comp.type });
          adj[c2].push({ target: c1, id: comp.id, type: comp.type });
      }
    });

    let activeComponentIds = new Set();
    let battery = batteries[0];
    
    // Start DFS from the positive column (c2) aiming for the negative column (c1)
    const sourceCol = battery.c2;
    const sinkCol = battery.c1; 

    const findPaths = (currCol, visitedCols, currentPathCompIds) => {
      if (currCol === sinkCol) {
        currentPathCompIds.forEach(id => activeComponentIds.add(id));
        return;
      }
      visitedCols.add(currCol);
      
      const neighbors = adj[currCol] || [];
      for (let edge of neighbors) {
          if (edge.id === battery.id && edge.target === sinkCol) continue;
          
          if (!visitedCols.has(edge.target)) {
            findPaths(edge.target, new Set(visitedCols), [...currentPathCompIds, edge.id]);
          }
      }
    };
    
    // Start search from the battery's positive terminal column, including the battery
    findPaths(sourceCol, new Set([sourceCol]), [battery.id]);
    
    // --- Validation ---
    
    let missionSuccess = activeComponentIds.size > 0; // Must have a closed circuit with components

    if (missionSuccess) {
      // 1. Check for required components (presence on board)
      const currentComponentCounts = currentComponents.reduce((acc, c) => {
          acc[c.type] = (acc[c.type] || 0) + 1;
          return acc;
      }, {});
      
      Object.keys(stage.requiredComponents).forEach(reqType => {
          if ((currentComponentCounts[reqType] || 0) < stage.requiredComponents[reqType]) {
              missionSuccess = false;
          }
      });
      
      // 2. Check if all *required output* components are active (part of the closed circuit)
      if (missionSuccess) {
          const activeComponentTypes = currentComponents.filter(c => activeComponentIds.has(c.id)).map(c => c.type);
          const activeLedCount = activeComponentTypes.filter(t => t === 'led').length;
          const activeBuzzerCount = activeComponentTypes.filter(t => t === 'buzzer').length;

          if (stage.requiredComponents.led && activeLedCount < stage.requiredComponents.led) missionSuccess = false;
          if (stage.requiredComponents.buzzer && activeBuzzerCount < stage.requiredComponents.buzzer) missionSuccess = false;
      }
    }
    
    return { activeComponentIds, missionSuccess };
  };

  /**
   * Wrapper to run simulation and update state (for both button press and auto-run).
   * @param {boolean} pressedState - The button state we are simulating against.
   * @param {Array<Object>} comps - The components list to use in the simulation.
   */
  const updateSimulationState = (pressedState, comps) => {
      const { activeComponentIds, missionSuccess } = runSimulation(pressedState, comps);
      
      setIsRunning(pressedState);
      setSuccess(missionSuccess);
      
      // Update component active status
      setComponents(comps.map(c => ({ ...c, active: activeComponentIds.has(c.id) })));

      // Provide feedback
      if (pressedState) {
          if (missionSuccess) {
              setSparkyMsg("Circuit Complete! It works!");
              triggerSound('success');
              if (comps.filter(c => c.type === 'buzzer' && activeComponentIds.has(c.id)).length > 0) {
                  triggerSound('buzz');
              }
          } else {
              setSparkyMsg("Circuit closed, but something is missing or connected wrong!");
              triggerSound('error');
          }
      } else {
          setSparkyMsg("Circuit open. Button released.");
      }
  };

  // Logic for continuous simulation (if no button required)
  const handleAutoSimulation = () => {
    const currentMission = MISSIONS.find(m => m.id === activeMissionId);
    if (!currentMission || currentMission.stages[activeStageIndex].requiredComponents.button) return;
    
    // Only auto-run if the simulation is currently stopped
    if (!isRunning) {
        updateSimulationState(true, components);
        // Auto-stop after 3 seconds
        setTimeout(() => {
            setIsRunning(false);
            // Must update state using the explicit map to ensure all are set to inactive
            setComponents(prev => prev.map(c => ({ ...c, active: false })));
        }, 3000);
    }
  };

  const toggleButtonPress = () => {
    // We use the inverse of the current state for the simulation calculation
    const nextIsPressed = !isButtonPressed; 
    
    setIsButtonPressed(nextIsPressed);
    triggerSound('click');
    
    // Run simulation using the NEW state and the current components list
    updateSimulationState(nextIsPressed, components);
  };


  const currentMission = MISSIONS.find(m => m.id === activeMissionId);
  const currentStage = currentMission ? currentMission.stages[activeStageIndex] : null;
  const themeColors = currentMission ? getThemeColors(currentMission.theme) : '';


  // --- RENDER ---
  return (
    <div className="min-h-screen transition-colors duration-500 bg-stone-100 text-slate-800 font-sans flex flex-col overflow-hidden">
      
      {/* Modals */}
      {showCredits && <CreditsModal onClose={() => setShowCredits(false)} />}
      {showBrief && <ProjectBriefModal onClose={() => setShowBrief(false)} />}
      {showSewing && <SewingSimulator onClose={() => setShowSewing(false)} />} 

      {screen === 'landing' && (
        <div className="flex-1 flex flex-col items-center justify-center p-4 relative bg-gradient-to-br from-[#1b103e] to-[#4c1e63] overflow-hidden">
          <style>
              {`
                  @keyframes icon-float {
                      0%, 100% { transform: translate(0, 0) rotate(0deg); opacity: 0.9; }
                      25% { transform: translate(20px, -30px) rotate(15deg); opacity: 0.8; }
                      50% { transform: translate(-10px, 30px) rotate(-10deg); opacity: 0.95; }
                      75% { transform: translate(-20px, -10px) rotate(5deg); opacity: 0.85; }
                  }
                  .floating-icon {
                      position: absolute;
                      opacity: 0.8;
                      filter: drop-shadow(0 0 8px #93c5fd);
                      animation: icon-float 15s infinite alternate ease-in-out;
                  }
                  .title-glow {
                      text-shadow: 0 0 10px #f0f9ff, 0 0 20px #93c5fd, 0 0 30px #3b82f6;
                  }
              `}
          </style>
           {/* Magical Floating Icons Background */}
           <div className="absolute inset-0 pointer-events-none opacity-80">
              {Array.from({ length: BG_ICON_COUNT }).map((_, i) => {
                  const Icon = BACKGROUND_ICONS[i % BACKGROUND_ICONS.length];
                  const size = 30 + Math.random() * 40;
                  const left = Math.random() * 100;
                  const top = Math.random() * 100;
                  const delay = Math.random() * -10;
                  const duration = 15 + Math.random() * 10;
                  const color = ["#6366f1", "#06b6d4", "#fcd34d"][i % 3];

                  return (
                      <Icon 
                          key={i}
                          className="floating-icon"
                          size={size}
                          style={{
                              left: `${left}vw`,
                              top: `${top}vh`,
                              animationDelay: `${delay}s`,
                              animationDuration: `${duration}s`,
                              color: color,
                              zIndex: 0,
                          }}
                      />
                  );
              })}
           </div>
           
            <div className="z-10 text-center max-w-4xl px-4 flex flex-col items-center pt-24 pb-12">
                
                <h1 className="text-6xl md:text-8xl font-black tracking-tighter mb-4 text-white title-glow drop-shadow-2xl">
                    CIRCUIT STORIES
                </h1>

                <p className="text-xl md:text-2xl mb-12 leading-relaxed max-w-xl text-indigo-200 font-semibold italic drop-shadow-md">
                    Your adventure starts with a **snap!**
                </p>
                
                <div className="flex flex-col md:flex-row gap-4">
                    <button onClick={() => { setScreen('mission-select'); triggerSound('snap'); }} className="px-12 py-5 text-xl font-black text-white bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full shadow-2xl hover:scale-105 transition-all flex items-center justify-center gap-3 border-2 border-indigo-300 hover:border-white ring-4 ring-indigo-500/50 hover:ring-indigo-500/80">
                        <Play fill="currentColor" /> START GAME
                    </button>
                    <button onClick={() => { setScreen('manual'); triggerSound('click'); }} className="px-8 py-5 text-lg font-bold border-2 rounded-full shadow-md transition-all flex items-center justify-center gap-2 bg-white/10 backdrop-blur-sm border-indigo-400 text-indigo-200 hover:bg-white/20 hover:scale-[1.02]">
                        <BookOpen size={20} /> Manual
                    </button>
                </div>
                <div className="flex gap-4 mt-6">
                    <button onClick={() => { setShowCredits(true); triggerSound('click'); }} className="px-4 py-2 text-sm font-bold border rounded-full shadow-sm transition-all flex items-center justify-center gap-2 bg-white/10 border-cyan-300 text-cyan-200 hover:bg-white/20 hover:scale-[1.05]">
                        <Users size={16} /> Credits
                    </button>
                    <button onClick={() => { setShowBrief(true); triggerSound('click'); }} className="px-4 py-2 text-sm font-bold border rounded-full shadow-sm transition-all flex items-center justify-center gap-2 bg-white/10 border-green-300 text-green-300 hover:bg-white/20 hover:scale-[1.05]">
                        <FileText size={16} /> Project Brief
                    </button>
                </div>
            </div>
            <Sparky mood="happy" message="Ready to start your electric adventure?" mobileCollapsed={false} />
        </div>
      )}

      {screen === 'mission-select' && (
          <div className="flex-1 p-4 md:p-6 overflow-y-auto bg-gradient-to-br from-stone-100 to-blue-50">
             <header className="flex items-center justify-between mb-8 max-w-6xl mx-auto">
                <h2 className="text-2xl md:text-4xl font-black flex items-center gap-3 tracking-tight text-blue-900 drop-shadow-sm">
                  <div className="w-8 h-8 text-yellow-500"><BatteryIcon /></div> Circuit Stories Missions
                </h2>
                <div className="flex gap-3">
                    <button onClick={() => setScreen('manual')} className="font-bold flex items-center gap-2 transition-colors px-4 py-2 rounded-full shadow-md bg-white text-slate-500 hover:text-blue-600 hover:shadow-lg hover:scale-[1.02] ring-2 ring-transparent hover:ring-blue-200"><BookOpen size={18} /> Manual</button>
                    <button onClick={() => setScreen('landing')} className="font-bold flex items-center gap-2 transition-colors px-4 py-2 rounded-full shadow-md bg-white text-slate-500 hover:text-blue-600 hover:shadow-lg hover:scale-[1.02] ring-2 ring-transparent hover:ring-blue-200"><Home size={18} /> Home</button>
                </div>
              </header>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto">
                  {MISSIONS.map((mission) => (
                      <div key={mission.id} onClick={() => handleStartMission(mission.id)} className="cursor-pointer relative group rounded-3xl overflow-hidden shadow-xl border-4 border-white bg-white hover:shadow-2xl hover:scale-[1.02] transition-all flex flex-col ring-4 ring-transparent group-hover:ring-blue-300/50">
                            {/* Mission Card Visuals */}
                            <div className="p-4 rounded-t-3xl border-b bg-gradient-to-r from-blue-50 to-white group-hover:from-blue-100 transition-colors">
                                <h3 className="font-black text-xl text-slate-800">{mission.title}</h3>
                                <p className="text-sm text-slate-500">Level {mission.stages.length > 1 ? `1 / ${mission.stages.length}` : '1 / 1'}</p>
                            </div>
                            <div className="flex-1 flex items-center justify-center relative z-10 p-4 pt-0">
                                <div className="text-7xl drop-shadow-lg transform transition-transform duration-500 pt-4 group-hover:scale-110">{mission.image}</div>
                            </div>
                            <div className="bg-white p-4 border-t border-slate-100 min-h-[100px]">
                                <p className="text-sm text-black leading-snug font-medium">{mission.stages[0].description}</p>
                            </div>
                            {/* Overlay Effect for interaction */}
                            <div className="absolute inset-0 bg-blue-500/0 group-hover:bg-blue-500/10 transition-all pointer-events-none"></div>
                      </div>
                  ))}
                  
                  <div className="md:col-span-2 lg:col-span-4 mt-8 mb-4 border-t-4 border-dashed border-slate-300 pt-8">
                        <h2 className="text-2xl font-black flex items-center gap-2 uppercase tracking-widest mb-6 text-slate-500">
                            <Sparkles size={24} className="text-yellow-500 animate-pulse" /> Future Adventures
                        </h2>
                    </div>

                    {/* Arduino Connection - Coming Soon */}
                    <div className="cursor-not-allowed relative group rounded-xl overflow-hidden shadow-inner border-4 border-dashed aspect-[3/4] flex flex-col opacity-80 grayscale bg-slate-100 border-slate-300">
                        <div className="absolute top-4 right-4 z-20"><Lock size={24} className="text-slate-400" /></div>
                        <div className="flex-1 flex items-center justify-center relative z-10 flex-col p-6 text-center">
                            <Cpu size={64} className="text-pink-600 mb-4" />
                            <h3 className="text-xl font-black mb-2 text-slate-800">Arduino Connect</h3>
                            <p className="text-xs leading-relaxed text-slate-600">Upgrade your builds with code! Connect your circuit board to programmable logic and unleash new creativity.</p>
                        </div>
                        <div className="bg-pink-600 p-2 text-center text-white text-xs font-bold uppercase tracking-widest">Coming Soon</div>
                    </div>

                    {/* Wearable Mode / Sewing Tutorial - Available */}
                    <div onClick={() => setShowSewing(true)} className="cursor-pointer relative group rounded-xl overflow-hidden shadow-xl border-4 border-blue-200 aspect-[3/4] flex flex-col bg-white hover:shadow-2xl hover:scale-[1.02] transition-all ring-4 ring-transparent group-hover:ring-teal-300/50">
                        <div className="flex-1 flex items-center justify-center relative z-10 flex-col p-6 text-center">
                            <Shirt size={64} className="text-teal-600 mb-4 group-hover:scale-105 transition-transform" />
                            <h3 className="text-xl font-black mb-2 text-slate-800">Wearable Mode</h3>
                            <p className="text-xs leading-relaxed text-slate-600">Tutorial: Learn how to sew your felt board onto a T-shirt and make your circuits wearable.</p>
                        </div>
                        <div className="bg-teal-600 p-2 text-center text-white text-xs font-bold uppercase tracking-widest group-hover:bg-teal-700 transition-colors">Start Tutorial</div>
                    </div>

                    {/* Magazine Teaser - Coming Soon */}
                    <div className="cursor-not-allowed relative group rounded-xl overflow-hidden shadow-inner border-4 border-dashed aspect-[3/4] flex flex-col opacity-80 grayscale bg-slate-100 border-slate-300">
                        <div className="absolute top-4 right-4 z-20"><Lock size={24} className="text-slate-400" /></div>
                        <div className="flex-1 flex items-center justify-center relative z-10 flex-col p-6 text-center">
                            <BookOpen size={64} className="text-teal-600 mb-4" />
                            <h3 className="text-xl font-black mb-2 text-slate-800">Circuit Adventures</h3>
                            <p className="text-xs leading-relaxed text-slate-600">Coming Soon! Dive deeper into Sparky's world...</p>
                        </div>
                        <div className="bg-teal-600 p-2 text-center text-white text-xs font-bold uppercase tracking-widest">Coming Soon</div>
                    </div>
              </div>
          </div>
      )}

      {screen === 'manual' && (
        <div className="min-h-screen bg-gradient-to-br from-stone-100 to-blue-50 text-slate-800 p-6 flex flex-col">
          <div className="max-w-4xl mx-auto w-full">
               <header className="flex items-center justify-between mb-8">
                    <h2 className="text-3xl font-black flex items-center gap-3 text-blue-900 drop-shadow-sm"><BookOpen className="text-blue-600" /> Circuit Manual</h2>
                    <button onClick={() => setScreen('landing')} className="font-bold flex items-center gap-2 transition-colors text-slate-400 hover:text-blue-400 hover:scale-[1.05]"><Home size={20} /> <span className="hidden md:inline">Back Home</span></button>
               </header>
               {/* Mobile: Tabs stretch fully. Desktop: Fixed width sidebar. */}
               <div className="rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row h-[80vh] md:h-[70vh] bg-white ring-4 ring-blue-500/10">
                   <div className="w-full md:w-64 border-r p-4 flex flex-row md:flex-col gap-2 overflow-x-auto md:overflow-x-hidden bg-slate-50 border-slate-200 shadow-inner shrink-0">
                        <button onClick={() => setManualTab('parts')} className={`flex items-center gap-3 p-3 rounded-xl transition-all font-black text-left whitespace-nowrap text-lg shadow-md ${manualTab === 'parts' ? 'bg-blue-600 text-white ring-4 ring-blue-300' : 'text-slate-600 bg-white hover:bg-blue-50 hover:text-blue-800'}`}><Info size={20} /> Parts Guide</button>
                        <button onClick={() => setManualTab('build')} className={`flex items-center gap-3 p-3 rounded-xl transition-all font-black text-left whitespace-nowrap text-lg shadow-md ${manualTab === 'build' ? 'bg-blue-600 text-white ring-4 ring-blue-300' : 'text-slate-600 bg-white hover:bg-blue-50 hover:text-blue-800'}`}><Scissors size={20} /> How to Build</button>
                   </div>
                   <div className="flex-1 p-6 overflow-y-auto">
                       {manualTab === 'parts' && (
                           <div className="space-y-6">
                               <h3 className="text-2xl font-extrabold text-slate-800 border-b pb-3 mb-4">The Circuit Kit Components</h3>
                               {Object.values(COMPONENT_TYPES).map(comp => (
                                   <div key={comp.id} className="flex items-center p-3 rounded-xl bg-white shadow-lg border border-slate-100">
                                       <div className="w-20 h-10 shrink-0">
                                          <comp.CustomIcon />
                                       </div>
                                       <div className="ml-4">
                                           <h4 className="font-bold text-lg text-blue-700 capitalize">{comp.label}</h4>
                                           <p className="text-sm text-slate-600">{comp.desc}</p>
                                       </div>
                                   </div>
                               ))}
                           </div>
                       )}
                       {manualTab === 'build' && (
                           <div className="space-y-6">
                               <h3 className="2xl font-extrabold text-slate-800 border-b pb-3 mb-4">Building Tips & Rules</h3>
                               
                               <div className="bg-blue-100/70 p-4 rounded-xl border border-blue-300 shadow-md ring-4 ring-blue-200/50">
                                   <h4 className="font-bold text-xl text-blue-800 flex items-center gap-2"><Zap size={20} className="text-yellow-500" /> The Golden Rule</h4>
                                   <p className="text-sm text-blue-800 mt-2 font-medium">A circuit must form a complete, unbroken loop from the **Battery (+)** back to the **Battery (-)**. If the loop is broken (an **open circuit**), nothing works.</p>
                               </div>

                               <h4 className="font-bold text-xl text-slate-700 mt-6">How the Felt Board Works (The Grid)</h4>
                               <p className="text-sm text-slate-600">The felt board is a simplified breadboard. All snaps in a single **vertical column** are permanently connected by conductive thread, simulating a strip. Components must bridge columns to connect them.</p>

                               <h4 className="font-bold text-xl text-slate-700 mt-6">Component Sizing</h4>
                               <ul className="list-disc list-inside text-sm ml-4 space-y-2">
                                   <li>**Fixed Parts (Battery, Light, Button, Buzzer):** These pieces are rigid and can only span **two adjacent snaps** in the **same row** (size 1).</li>
                                   <li>**Flexible Wire (Connector):** This piece is versatile and can connect **any two snaps** on the board, bridging large gaps or connecting diagonally.</li>
                               </ul>
                               
                               <h4 className="font-bold text-xl text-slate-700 mt-6">Types of Circuits</h4>
                               <ul className="list-disc list-inside text-sm ml-4 space-y-2">
                                   <li>**Simple Loop:** One battery powers one output (Light/Buzzer).</li>
                                   <li>**Parallel:** Connecting multiple outputs (Lights/Buzzers) across the same two columns. This lets them all run at full power from the same source.</li>
                                   <li>**Series:** (Advanced) Outputs are chained from column to column. This splits the power, often dimming the lights, but is useful for complex switches.</li>
                               </ul>
                           </div>
                       )}
                   </div>
               </div>
          </div>
        </div>
      )}

      {screen === 'workbench' && currentStage && (
        <div className="flex-1 flex flex-col md:flex-row relative overflow-hidden min-h-screen bg-gradient-to-br from-stone-100 to-slate-200">
           
           <Sparky 
                mood={success ? 'excited' : (isRunning ? 'speaking' : 'happy')}
                message={sparkyMsg}
                mobileCollapsed={false}
                onHint={handleHint}
                isWorkbench={true} 
            />

            {/* Mission Info Column (Left/Top Mobile) */}
            <div className={`p-4 md:p-6 md:w-80 md:shrink-0 bg-white shadow-lg md:shadow-2xl md:overflow-y-auto transition-all relative ring-4 ring-blue-500/10 ${showMissionDetails ? 'h-full' : 'h-auto max-h-[30vh] md:max-h-full'}`}>
                <div className="flex items-center justify-between mb-4">
                    <button onClick={() => setScreen('mission-select')} className="text-slate-400 hover:text-blue-600 flex items-center gap-1 text-sm font-bold hover:scale-[1.02] transition-transform">
                        <ArrowRight className="rotate-180" size={16} /> Back to Missions
                    </button>
                    {/* Mobile Toggle Button */}
                    <button 
                        onClick={() => setShowMissionDetails(!showMissionDetails)}
                        className="md:hidden text-blue-600 font-bold flex items-center gap-1 text-sm bg-blue-50 p-2 rounded-full hover:bg-blue-100 transition-colors"
                    >
                        {showMissionDetails ? <ChevronUp size={16} /> : <ChevronDown size={16} />} Mission Details
                    </button>
                </div>
                
                <div className={`${showMissionDetails ? 'block' : 'hidden md:block'} transition-all duration-300`}>
                    <div className={`rounded-xl shadow-lg border-4 ${success ? 'border-green-500 bg-green-50/70' : 'border-slate-300 bg-gray-100'} p-4 relative transition-colors duration-500 ring-4 ${success ? 'ring-green-300/50' : 'ring-transparent'}`}>
                        <div className="flex items-center justify-between">
                            <h3 className="text-xl font-black text-slate-800">{currentMission.title}</h3>
                            <div className="text-3xl">{currentMission.image}</div>
                        </div>
                        <p className="text-sm font-medium text-slate-500 mb-3">
                            Level {activeStageIndex + 1} / {currentMission.stages.length}
                        </p>

                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-inner">
                            <p className="text-sm text-slate-700 leading-snug font-bold">{currentStage.description}</p>
                        </div>

                        <div className="mt-4 pt-4 border-t border-slate-200">
                            <h4 className="font-extrabold text-sm text-blue-700 mb-2 uppercase tracking-wider">Challenge Components</h4>
                            <p className="text-xs text-slate-600 font-medium">{currentStage.challenge}</p>
                        </div>
                    </div>

                    <div className="mt-6 space-y-3">
                         {success && activeStageIndex < currentMission.stages.length - 1 ? (
                            <button onClick={handleNextStage} className="w-full px-4 py-3 bg-indigo-600 text-white rounded-xl font-black shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 hover:scale-[1.01] ring-4 ring-indigo-300/50">
                                <Star size={20} /> Advance to Level {activeStageIndex + 2}
                            </button>
                        ) : success && activeStageIndex === currentMission.stages.length - 1 ? (
                            <div className="text-center p-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-black text-lg shadow-lg animate-pulse ring-4 ring-green-300">
                                MISSION COMPLETE! ðŸ¥³
                            </div>
                        ) : (
                            isSolutionMode ? (
                                <button onClick={handleTryItYourself} className="w-full px-4 py-3 bg-yellow-600 text-white rounded-xl font-bold shadow-lg hover:bg-yellow-700 transition-all flex items-center justify-center gap-2 hover:scale-[1.01] ring-4 ring-yellow-300/50">
                                    <RefreshCcw size={20} /> Try It Yourself
                                </button>
                            ) : (
                                <button onClick={loadSolution} className="w-full px-4 py-3 bg-slate-400 text-white rounded-xl font-bold shadow-lg hover:bg-slate-500 transition-all flex items-center justify-center gap-2 hover:scale-[1.01] ring-4 ring-slate-300/50">
                                    <HelpCircle size={20} /> Show Solution
                                </button>
                            )
                        )}
                    </div>
                </div>
            </div>

            {/* Main Workbench Area (Center) */}
            <div className="flex-1 p-4 md:p-6 flex flex-col overflow-y-auto">
                <div className="flex-1 flex items-start justify-center overflow-y-auto pb-4">
                    <div className="relative w-full max-w-full md:max-w-2xl p-2 md:p-8 bg-white rounded-xl shadow-2xl border-4 border-stone-200 ring-4 ring-stone-300/50">
                         {/* Scrollable Canvas Container: Ensures horizontal overflow is handled if needed */}
                        <div className="overflow-x-auto overflow-y-auto max-h-[85vh] p-2">
                            <div 
                                className="relative bg-stone-200 rounded-lg shadow-inner mx-auto"
                                style={{
                                    width: GRID_COLS * STRIDE + GAP_SIZE, // Fixed intrinsic width
                                    height: GRID_ROWS * STRIDE + GAP_SIZE, // Fixed intrinsic height
                                    padding: GAP_SIZE / 2,
                                    backgroundImage: FELT_GRID_BG_URI, // Use SVG Data URI
                                    backgroundSize: 'cover',
                                    backgroundPosition: 'center',
                                    backgroundColor: '#eee',
                                    border: '3px solid #ccc'
                                }}
                            >
                                {/* ---------------------------------------------------- */}
                                {/* Visual Conduction Lines (Z-index 0 - underneath everything) */}
                                {/* ---------------------------------------------------- */}
                                {Array.from({ length: GRID_COLS }).map((_, c) => (
                                    <div
                                        key={`conn-line-${c}`}
                                        className="absolute z-0"
                                        style={{
                                            left: c * STRIDE + CELL_SIZE / 2 - 2.5, // Center the line on the column center
                                            top: 0,
                                            width: 5, 
                                            height: '100%',
                                        }}
                                    >
                                        <svg width="5" height="100%" viewBox={`0 0 5 ${GRID_ROWS * STRIDE + GAP_SIZE}`} preserveAspectRatio="none" className="w-full h-full">
                                            <line 
                                                x1="2.5" 
                                                y1="0" 
                                                x2="2.5" 
                                                y2={GRID_ROWS * STRIDE + GAP_SIZE} 
                                                stroke="#3b82f6" // Use a conductive blue color
                                                strokeWidth="2" 
                                                strokeDasharray="4 8" // Dashed line to show it's an underlying connection
                                                opacity="0.3" // Make it subtle
                                                className={isRunning ? 'animate-pulse' : ''}
                                                style={isRunning ? { stroke: '#38BDF8', filter: 'drop-shadow(0 0 4px #38BDF8)' } : {}}
                                            />
                                        </svg>
                                    </div>
                                ))}


                                {/* Snap Grid (Smaller Size - Rendered ABOVE the background image) */}
                                {Array.from({ length: GRID_ROWS }).map((_, r) =>
                                    Array.from({ length: GRID_COLS }).map((_, c) => {
                                        const isDragStart = dragStart && dragStart.r === r && dragStart.c === c;
                                        const isTargetSnap = selectedTool && !isDragStart;
                                        
                                        // Snaps are the connection points, adjusted to match the coordinates implied by the background image
                                        // z-index 10 for snaps
                                        return (
                                            <div
                                                key={`${r}-${c}`}
                                                className={`absolute cursor-pointer rounded-full transition-all duration-100 z-10 
                                                    ${isDragStart ? 'bg-red-500 shadow-xl' : 
                                                    'bg-blue-300/40 hover:bg-blue-400/60'}`} // Enhanced color/effect for snap points
                                                style={{
                                                    left: c * STRIDE + GAP_SIZE / 2,
                                                    top: r * STRIDE + GAP_SIZE / 2,
                                                    width: CELL_SIZE, 
                                                    height: CELL_SIZE,
                                                    // Ensure the snap points look like fasteners
                                                    border: '2px solid #5a5a5a',
                                                    boxShadow: 'inset 0 0 5px rgba(0,0,0,0.3)',
                                                    opacity: 0.9,
                                                    transform: isDragStart ? 'scale(1.25)' : isTargetSnap ? 'scale(1.1)' : 'scale(1)',
                                                    filter: isTargetSnap ? 'drop-shadow(0 0 5px #60a5fa)' : 'none',
                                                }}
                                                onClick={() => handleSnapClick(r, c)}
                                            />
                                        );
                                    })
                                )}
                                
                                {/* Components (Rendered ABOVE Snaps, Z-Index 20) */}
                                {components.map(comp => {
                                    const tool = COMPONENT_TYPES[comp.type.toUpperCase()];
                                    const x1 = comp.c1 * STRIDE + CELL_SIZE / 2;
                                    const y1 = comp.r1 * STRIDE + CELL_SIZE / 2;
                                    const x2 = comp.c2 * STRIDE + CELL_SIZE / 2;
                                    const y2 = comp.r2 * STRIDE + CELL_SIZE / 2;
                                    
                                    // Calculate center, angle, and distance for flexible wire
                                    const dx = x2 - x1;
                                    const dy = y2 - y1;
                                    const dist = Math.sqrt(dx * dx + dy * dy);
                                    const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                                    const midX = (x1 + x2) / 2;
                                    const midY = (y1 + y2) / 2;

                                    const isActive = comp.active && isRunning;

                                    if (tool.width === 'fixed') {
                                        // Fixed Parts (Horizontal only)
                                        return (
                                            <div
                                                key={comp.id}
                                                className={`absolute cursor-pointer transition-all duration-300 z-20 ${isActive ? (comp.type === 'led' ? 'animate-pulse' : comp.type === 'buzzer' ? 'animate-vibrate' : '') : ''}`}
                                                style={{
                                                    left: Math.min(x1, x2),
                                                    top: y1 - 30, // Center vertically on a 60px height (component height)
                                                    width: STRIDE,
                                                    height: 60,
                                                }}
                                                onClick={() => handleRemoveComponent(comp.id)}
                                            >
                                                <div className={`relative ${isActive ? (comp.type === 'led' ? 'opacity-100 drop-shadow-lg' : comp.type === 'buzzer' ? 'opacity-100' : 'opacity-100') : 'opacity-80'} hover:scale-[1.05] transition-transform`}>
                                                    <tool.CustomIcon />
                                                    {/* Active Glow for Fixed Parts */}
                                                    {isActive && (
                                                        <div className={`absolute inset-0 rounded-lg opacity-50 mix-blend-lighten pointer-events-none transition-opacity duration-100 
                                                            ${comp.type === 'battery' ? 'bg-green-300' : comp.type === 'led' ? 'bg-yellow-300 animate-blink ring-4 ring-yellow-400/50' : comp.type === 'buzzer' ? 'bg-orange-300 animate-pulse ring-4 ring-orange-400/50' : comp.type === 'button' ? 'bg-red-300' : ''}`}
                                                        />
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    } else {
                                        // Flexible Wire
                                        const wireWidth = Math.max(dist, 10);
                                        return (
                                            <div
                                                key={comp.id}
                                                className={`absolute cursor-pointer transition-all duration-300 z-20 ${isActive ? 'opacity-100' : 'opacity-80'} hover:scale-[1.05] transition-transform`}
                                                style={{
                                                    left: midX - wireWidth / 2,
                                                    top: midY - 15, // Center vertically
                                                    width: wireWidth,
                                                    height: 30,
                                                    transform: `rotate(${angle}deg)`,
                                                    transformOrigin: 'center center',
                                                }}
                                                onClick={() => handleRemoveComponent(comp.id)}
                                            >
                                                <svg width={wireWidth} height="30" viewBox={`0 0 ${wireWidth} 30`} className="w-full h-full">
                                                    <defs>
                                                        <linearGradient id={`wireGrad-${comp.id}`} x1="0%" y1="0%" x2="100%" y2="0%">
                                                            <stop offset="0%" stopColor={isActive ? "#38BDF8" : "#80aaff"} />
                                                            <stop offset="100%" stopColor={isActive ? "#06B6D4" : "#4f7ff6"} />
                                                        </linearGradient>
                                                    </defs>
                                                    <rect x="0" y="10" width={wireWidth} height="10" rx="5" fill={`url(#wireGrad-${comp.id})`} stroke="#1d4ed8" strokeWidth="1" />
                                                    {isActive && <line x1="10" y1="15" x2={wireWidth - 10} y2="15" stroke="#fff" strokeWidth="2" strokeDasharray="6 4" className="animate-pulse" />}
                                                </svg>
                                            </div>
                                        );
                                    }
                                })}
                            </div>
                        </div>
                    </div>
                </div>

                {/* --- New Control Bar Position (Below Breadboard, Above Kit) --- */}
                <div className="flex justify-center items-center gap-4 mt-6">
                    {/* TEST / PUSH BUTTON */}
                    {currentStage.requiredComponents.button ? (
                        <button 
                            onClick={toggleButtonPress}
                            className={`w-full max-w-[200px] px-8 py-4 font-black rounded-full shadow-xl transition-all flex items-center justify-center gap-2 text-lg hover:scale-[1.02] ${isButtonPressed ? 'bg-red-700 text-white hover:bg-red-800 ring-4 ring-red-300' : 'bg-red-500 text-white hover:bg-red-600 ring-4 ring-red-300/50'}`}
                        >
                            <Play fill="currentColor" size={20} /> 
                            {isButtonPressed ? 'RELEASE BUTTON' : 'PRESS BUTTON'}
                        </button>
                    ) : (
                        <button 
                            onClick={handleAutoSimulation} // Use the auto-simulation handler
                            disabled={isRunning}
                            className={`w-full max-w-[200px] px-8 py-4 font-black rounded-full shadow-xl transition-all flex items-center justify-center gap-2 text-lg ${isRunning ? 'bg-green-700/50 text-white/70 cursor-not-allowed ring-4 ring-green-300' : 'bg-green-500 text-white hover:bg-green-600 hover:scale-[1.02] ring-4 ring-green-300/50'}`}
                        >
                            <Zap size={20} /> 
                            {isRunning ? 'TESTING...' : 'TEST CIRCUIT'}
                        </button>
                    )}
                    
                    <button onClick={clearBoard} className="w-full max-w-[200px] px-6 py-4 bg-slate-200 text-slate-700 rounded-full font-bold shadow-md hover:bg-slate-300 transition-all flex items-center justify-center gap-2 text-lg hover:scale-[1.02] ring-2 ring-slate-300/50">
                        <Trash2 size={20} /> Clear Board
                    </button>
                </div>
                {/* --- End New Control Bar Position --- */}

                {/* Parts Kit (Original bottom bar container, now simplified) */}
                <div className="p-4 bg-white shadow-2xl rounded-3xl border-t border-slate-200 flex justify-center items-center gap-4 mt-6 ring-4 ring-blue-500/10">
                    {/* Parts Kit */}
                    <div className="flex overflow-x-auto gap-4 py-2 px-2 w-full justify-center">
                        {Object.keys(COMPONENT_TYPES).map(key => {
                            const comp = COMPONENT_TYPES[key];
                            const isSelected = selectedTool === comp.id;
                            return (
                                <button
                                    key={comp.id}
                                    onClick={() => setSelectedTool(selectedTool === comp.id ? null : comp.id)}
                                    className={`p-2 rounded-2xl shadow-lg border-4 transition-all w-24 h-24 shrink-0 flex flex-col items-center justify-center ${isSelected ? 'border-blue-500 bg-white/90 scale-105 shadow-xl ring-4 ring-blue-300' : 'border-slate-200 bg-white hover:border-blue-300 hover:scale-[1.02] ring-2 ring-transparent'}`}
                                    title={`Add ${comp.label}`}
                                >
                                    <div className="w-12 h-8">
                                        <comp.CustomIcon />
                                    </div>
                                    <span className="text-xs font-bold mt-1 text-slate-700">{comp.label}</span>
                                </button>
                            );
                        })}
                    </div>
                </div>
            </div>
        </div>
      )}
    </div>
  );
}